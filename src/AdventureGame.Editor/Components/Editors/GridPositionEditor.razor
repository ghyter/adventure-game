@using AdventureGame.Engine.Models
@using AdventureGame.Engine.Models.Elements

<RadzenFieldset Text="@Label" Style="width:100%">
    <RadzenStack Orientation="Orientation.Horizontal" Gap="8" Style="align-items:center;">
        <RadzenFormField Text="Col" Style="display:inline-block; min-width:5.5ch;">
            <RadzenNumeric Value="Value.X"
                           TValue="int"
                           Placeholder="Col"
                           Style="width:15ch"
                           Change="@(async (x) => await UpdatePosition(x, Value.Y))" />
        </RadzenFormField>

        <RadzenFormField Text="Row" Style="display:inline-block; min-width:5.5ch;">
            <RadzenNumeric Value="Value.Y"
                           TValue="int"
                           Placeholder="Row"
                           Style="width:15ch"
                           Change="@(async (y) => await UpdatePosition(Value.X, y))" />
        </RadzenFormField>

        <RadzenFormField Text="Level" Style="display:inline-block; min-width:12ch;">
            <RadzenDropDown Data="@LevelOptions"
                            TextProperty="Name"
                            ValueProperty="Id"
                            @bind-Value="LevelId"
                            TValue="ElementId?"
                            Style="width:18ch"
                            AllowClear="true"
                            Change="@(async (v) => await OnDropDownValueChanged(v))" />
        </RadzenFormField>

    </RadzenStack>
</RadzenFieldset>

@code {
    [Parameter] public GridPosition Value { get; set; }
    [Parameter] public EventCallback<GridPosition> ValueChanged { get; set; }
    [Parameter] public string Label { get; set; } = "Grid Position";
    [Parameter] public EventCallback<GridPosition> OnChange { get; set; }

    // Level binding support
    private ElementId? _levelId;
    [Parameter]
    public ElementId? LevelId
    {
        get => _levelId;
        set => _levelId = value;
    }

    [Parameter] public EventCallback<ElementId?> LevelIdChanged { get; set; }
    [Parameter] public List<Level>? LevelOptions { get; set; } = new();

    private async Task UpdatePosition(object? x, object? y)
    {
        var newPosition = new GridPosition(
            x is int xi ? xi : Value.X,
            y is int yi ? yi : Value.Y
        );
        await ValueChanged.InvokeAsync(newPosition);
        await OnChange.InvokeAsync(newPosition);
    }

    private async Task OnDropDownValueChanged(object? v)
    {
        // update local value
        LevelId = v as ElementId?;
        // notify parent and await so parent SelectedLevelId updates before we trigger location save
        await LevelIdChanged.InvokeAsync(LevelId);
        // Notify that position (with new level) changed so consumers can rebuild Location
        await OnChange.InvokeAsync(Value);
    }
}
