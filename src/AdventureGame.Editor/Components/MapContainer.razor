@using AdventureGame.Engine.Models.Elements
@inject CurrentGameService CurrentGameService
@inject DialogService DialogService

@if (CurrentGameService.CurrentPack is null)
{
    <RadzenAlert Severity="AlertSeverity.Warning">No game pack loaded.</RadzenAlert>
}
else
{
    <div class="map-container">
        <MapToolbar Scale="@Scale"
                    SelectedLevelId="@SelectedLevelId"
                    OnZoomChanged="@OnZoomChanged"
                    OnLevelChanged="@OnLevelChanged" />

        <div class="map-main" style="display:flex; gap:16px; align-items:flex-start;">
            <MapCanvas Scale="@Scale"
                       SelectedLevelId="@SelectedLevelId"
                       Elements="@Elements"
                       OnElementSelected="@OnElementSelected" />
            @if (SelectedElement is not null)
            {
                <RadzenPanel Style="min-width:300px;">
                    <HeaderTemplate>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <RadzenText TextStyle="TextStyle.H6">Selected Element</RadzenText>
                            <RadzenButton ButtonStyle="ButtonStyle.Light" Icon="close" Size="ButtonSize.Small" Click="@(() => SelectedElement = null)" />
                        </div>
                    </HeaderTemplate>
                    <ChildContent>
                        <div style="padding:12px;">
                            <strong>@SelectedElement.Name</strong>
                            <div style="font-size:0.8rem; opacity:0.7;">@SelectedElement.Kind</div>
                            <p>@SelectedElement.Description</p>
                            <RadzenButton Icon="edit" Text="Edit" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Primary" Click="@(() => EditElement(SelectedElement))" />
                        </div>
                    </ChildContent>
                </RadzenPanel>
            }
        </div>
    </div>
}

@code {
    private double Scale = 1.0;
    private ElementId? SelectedLevelId;
    private IEnumerable<GameElement>? Elements;
    private GameElement? SelectedElement;

    private const double MinScale = 0.25;
    private const double MaxScale = 4.0;

    protected override void OnInitialized()
    {
        LoadElements();
        CurrentGameService.OnChange += OnPackChanged;
    }

    private void OnPackChanged()
    {
        LoadElements();
        InvokeAsync(StateHasChanged);
    }

    private void LoadElements()
    {
        Elements = CurrentGameService.CurrentPack?.Elements;
        if (SelectedLevelId is null && Elements is not null)
        {
            SelectedLevelId = Elements.OfType<Level>().FirstOrDefault()?.Id;
        }
    }

    private Task OnZoomChanged(double newZoom)
    {
        Scale = Math.Clamp(newZoom, MinScale, MaxScale);
        return Task.CompletedTask;
    }

    private Task OnLevelChanged(ElementId? id)
    {
        SelectedLevelId = id;
        SelectedElement = null; // clear selection
        return Task.CompletedTask;
    }

    private Task OnElementSelected(GameElement el)
    {
        SelectedElement = el;
        return Task.CompletedTask;
    }

    private void EditElement(GameElement el)
    {
        var parameters = new Dictionary<string, object?> { ["Element"] = el };
        DialogService.OpenSide<GameElementEditor>("Edit Element", parameters, new SideDialogOptions { Width = "70%" });
    }

    public void Dispose()
    {
        CurrentGameService.OnChange -= OnPackChanged;
    }
}