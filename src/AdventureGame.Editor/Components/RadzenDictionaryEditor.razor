@typeparam TKey
@typeparam TValue
@using AdventureGame.Engine.Models
@using Radzen
@using Radzen.Blazor

<div>
  <RadzenButton Icon="add" Size="ButtonSize.Small" Click="AddNew">Add</RadzenButton>

  <RadzenDataGrid Data="@items" TItem="DictItem" Style="margin-top:8px;" RowHover="true">
    <Columns>
      <RadzenDataGridColumn TItem="DictItem" Property="KeyString" Title="Key">
        <Template Context="item">
          <RadzenTextBox @bind-Value="item.KeyString" Style="width:100%" Change="@( (string? _) => OnItemChanged() )" />
        </Template>
      </RadzenDataGridColumn>

      <RadzenDataGridColumn TItem="DictItem" Title="Value">
        <Template Context="item">
          @if (typeof(TValue) == typeof(int))
          {
              <RadzenNumeric TValue="int" @bind-Value="item.ValueAsInt" Change="@( (int _) => OnItemChanged() )" Style="width:100%" />
          }
          else if (typeof(TValue) == typeof(bool))
          {
              <RadzenCheckBox @bind-Value="item.ValueAsBool" Change="@( (bool _) => OnItemChanged() )" />
          }
          else if (typeof(TValue) == typeof(GameState))
          {
              <RadzenTextArea @bind-Value="item.ValueAsGameState.Description" Change="@( (string? _) => OnItemChanged() )" Rows="2" Style="width:100%" />
          }
          else
          {
              <RadzenTextBox @bind-Value="item.ValueAsString" Change="@( (string? _) => OnItemChanged() )" Style="width:100%" />
          }
        </Template>
      </RadzenDataGridColumn>

      <RadzenDataGridColumn TItem="DictItem" Title="">
        <Template Context="item">
          <RadzenButton Icon="delete" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Danger" Click="@(async _ => await Remove(item))" />
        </Template>
      </RadzenDataGridColumn>
    </Columns>
  </RadzenDataGrid>
</div>

@code {
  [Parameter] public IDictionary<TKey, TValue> Dictionary { get; set; } = new Dictionary<TKey, TValue>();
  [Parameter] public EventCallback OnChange { get; set; }

  private class DictItem
  {
    public string? KeyString { get; set; }        // string representation for editing
    public object? ValueBox { get; set; }        // boxed value

    // typed accessors
    public int ValueAsInt
    {
      get => ValueBox is null ? 0 : (int)ValueBox;
      set => ValueBox = value;
    }
    public bool ValueAsBool
    {
      get => ValueBox is null ? false : (bool)ValueBox;
      set => ValueBox = value;
    }
    public string? ValueAsString
    {
      get => ValueBox?.ToString();
      set => ValueBox = (TValue?)(object?)value!;
    }
    public GameState ValueAsGameState
    {
      get => ValueBox as GameState ?? new GameState("", null);
      set => ValueBox = value;
    }
    public TKey? ParsedKey(Func<string?, TKey?> parseKey)
      => parseKey(KeyString);
  }

  private List<DictItem> items = new();

  protected override void OnParametersSet()
  {
    items = Dictionary.Select(kv =>
    {
      var di = new DictItem { KeyString = kv.Key?.ToString(), ValueBox = kv.Value };
      return di;
    }).ToList();
  }

  private async Task AddNew()
  {
    items.Add(new DictItem { KeyString = "", ValueBox = default(TValue)! });
    await PushToSource();
  }

  private async Task Remove(DictItem item)
  {
    items.Remove(item);
    await PushToSource();
  }

  private Task OnItemChanged()
  {
    // Return the PushToSource task so the Change handlers receive a Func<T, Task>
    return PushToSource();
  }

  private async Task PushToSource()
  {
    Dictionary.Clear();
    foreach (var it in items)
    {
      // parse key back into TKey
      if (TryParseKey(it.KeyString, out var key))
      {
        // convert boxed value to TValue (best-effort)
        var value = ConvertValueBox(it.ValueBox);
        if (key is not null)
        {
          try { Dictionary[key] = value!; } catch { }
        }
      }
    }
    // Invoke the non-generic EventCallback with null argument to avoid conversion issues.
    await OnChange.InvokeAsync(null);
  }

  private bool TryParseKey(string? s, out TKey? key)
  {
    key = default;
    if (typeof(TKey) == typeof(string))
    {
      key = (TKey?)(object?)(s ?? "");
      return true;
    }
    try
    {
      if (typeof(TKey) == typeof(int) && int.TryParse(s, out var i))
      { key = (TKey?)(object?)i; return true; }
      // add other key parsers as needed
    }
    catch { }
    return false;
  }

  private TValue? ConvertValueBox(object? box)
  {
    if (box is null) return default;
    if (box is TValue tv) return tv;
    // best-effort conversions
    if (typeof(TValue) == typeof(string)) return (TValue)(object?)box.ToString();
    if (typeof(TValue) == typeof(int) && int.TryParse(box.ToString(), out var i)) return (TValue)(object)i;
    if (typeof(TValue) == typeof(bool) && bool.TryParse(box.ToString(), out var b)) return (TValue)(object)b;
    if (typeof(TValue) == typeof(GameState) && box is GameState gs) return (TValue)(object)gs;
    return default;
  }
}