@using AdventureGame.Engine.Models.Actions
@using AdventureGame.Engine.Effects

@code {
    [Parameter] public List<EffectRange> Ranges { get; set; } = new();
    [Parameter] public EventCallback OnChange { get; set; }

    private void AddRange()
    {
        Ranges.Add(new EffectRange { MinRoll = 1, MaxRoll = 20 });
        _ = OnChange.InvokeAsync();
    }

    private void RemoveRange(EffectRange r)
    {
        Ranges.Remove(r);
        _ = OnChange.InvokeAsync();
    }

    private void AddEffect(EffectRange r)
    {
        r.Definitions.Add(new EffectDefinition());
        _ = OnChange.InvokeAsync();
    }

    private void RemoveEffect(EffectRange r, EffectDefinition def)
    {
        r.Definitions.Remove(def);
        _ = OnChange.InvokeAsync();
    }
}

<RadzenFieldset Text="Effect Ranges (Roll Table)" Style="width:100%">
    <RadzenStack Orientation="Orientation.Vertical" Gap="10" Style="width:100%">
        @if (Ranges.Count == 0)
        {
            <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat">
                No ranges defined.
            </RadzenAlert>
        }

        @foreach (var r in Ranges.ToList())
        {
            <RadzenCard Style="padding:8px;">
                <RadzenStack Orientation="Orientation.Vertical" Gap="6" Style="width:100%">
                    <RadzenRow>
                        <RadzenColumn Size="12">
                            <RadzenBadge Text="@($"Range {Ranges.IndexOf(r) + 1}")" BadgeStyle="BadgeStyle.Primary" />
                            <RadzenButton Icon="delete" 
                                        Size="ButtonSize.Small" 
                                        ButtonStyle="ButtonStyle.Danger" 
                                        Style="float:right" 
                                        Click="@(_ => RemoveRange(r))" />
                        </RadzenColumn>
                    </RadzenRow>
                    <RadzenRow>
                        <RadzenColumn Size="6">
                            <RadzenFormField Text="Min Roll">
                                <RadzenNumeric TValue="int" 
                                             Style="width:12ch" 
                                             @bind-Value="r.MinRoll" 
                                             Change="@(_=>OnChange.InvokeAsync())" />
                            </RadzenFormField>
                        </RadzenColumn>
                        <RadzenColumn Size="6">
                            <RadzenFormField Text="Max Roll">
                                <RadzenNumeric TValue="int" 
                                             Style="width:12ch" 
                                             @bind-Value="r.MaxRoll" 
                                             Change="@(_=>OnChange.InvokeAsync())" />
                            </RadzenFormField>
                        </RadzenColumn>
                    </RadzenRow>

                    @* Effects in this range *@
                    @if (!r.Definitions.Any())
                    {
                        <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" Style="margin-top: 8px;">
                            No effects for this range.
                        </RadzenAlert>
                    }
                    else
                    {
                        @foreach (var def in r.Definitions.ToList())
                        {
                            <RadzenCard Style="padding: 8px; margin-top: 8px;">
                                <RadzenStack Orientation="Orientation.Vertical" Gap="8">
                                    <RadzenStack Orientation="Orientation.Horizontal" Gap="8" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                        <RadzenBadge Text="Effect" BadgeStyle="BadgeStyle.Success" />
                                        <RadzenButton Icon="delete" 
                                                    Size="ButtonSize.Small" 
                                                    ButtonStyle="ButtonStyle.Danger" 
                                                    Click="@(_ => RemoveEffect(r, def))" />
                                    </RadzenStack>
                                    <EffectNodeEditor Definition="@def" OnChange="@OnChange" />
                                </RadzenStack>
                            </RadzenCard>
                        }
                    }

                    <RadzenButton Icon="add" 
                                Text="Add Effect to Range" 
                                ButtonStyle="ButtonStyle.Success"
                                Size="ButtonSize.Small"
                                Style="margin-top: 8px;"
                                Click="@(_ => AddEffect(r))" />
                </RadzenStack>
            </RadzenCard>
        }

        <RadzenButton Icon="add" 
                    Text="Add Range" 
                    ButtonStyle="ButtonStyle.Primary"
                    Click="@(_ => AddRange())" />
    </RadzenStack>
</RadzenFieldset>
