@using AdventureGame.Engine.Models.Actions
@using AdventureGame.Engine.Conditions

@code {
    [Parameter] public ConditionGroup Group { get; set; } = new();
    [Parameter] public EventCallback OnChange { get; set; }

    private static IEnumerable<LogicOperator> LogicOptions => Enum.GetValues<LogicOperator>();

    private void AddCondition()
    {
        Group.Nodes.Add(ConditionNode.FromDefinition(new ConditionDefinition()));
        _ = OnChange.InvokeAsync();
    }

    private void AddGroup()
    {
        Group.Nodes.Add(ConditionNode.FromGroup(new ConditionGroup()));
        _ = OnChange.InvokeAsync();
    }

    private void RemoveNode(ConditionNode node)
    {
        Group.Nodes.Remove(node);
        _ = OnChange.InvokeAsync();
    }
}

<RadzenFieldset Text="Condition Group" Style="width:100%">
    <RadzenStack Orientation="Orientation.Vertical" Gap="8" Style="width:100%">
        <RadzenFormField Text="Operator">
            <RadzenDropDown TValue="LogicOperator"
                            Data="@LogicOptions"
                            @bind-Value="Group.Operator"
                            Style="width:16ch"
                            Change="@(_=>OnChange.InvokeAsync())" />
        </RadzenFormField>

        @if (Group.Nodes.Count == 0)
        {
            <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat">
                No conditions. Add one below.
            </RadzenAlert>
        }

        @foreach (var node in Group.Nodes.ToList())
        {
            <RadzenCard Style="padding:8px;">
                <RadzenStack Orientation="Orientation.Vertical" Gap="6" Style="width:100%">
                    <RadzenRow>
                        <RadzenColumn Size="12">
                            @if (node.IsLeaf)
                            {
                                <RadzenBadge Text="Condition" BadgeStyle="BadgeStyle.Success" />
                            }
                            else if (node.IsGroup)
                            {
                                <RadzenBadge Text="Nested Group" BadgeStyle="BadgeStyle.Info" />
                            }
                            <RadzenButton Icon="delete" 
                                        Size="ButtonSize.Small" 
                                        ButtonStyle="ButtonStyle.Danger" 
                                        Style="float:right" 
                                        Click="@(_ => RemoveNode(node))" />
                        </RadzenColumn>
                    </RadzenRow>
                    
                    @if (node.Definition is not null)
                    {
                        <ConditionNodeEditor Definition="@node.Definition" OnChange="@OnChange" />
                    }
                    else if (node.ConditionGroup is not null)
                    {
                        <ConditionGroupEditor Group="@node.ConditionGroup" OnChange="OnChange" />
                    }
                </RadzenStack>
            </RadzenCard>
        }

        <RadzenStack Orientation="Orientation.Horizontal" Gap="8">
            <RadzenButton Icon="add" 
                        Text="+ Condition" 
                        ButtonStyle="ButtonStyle.Success"
                        Click="@(_ => AddCondition())" />
            <RadzenButton Icon="add" 
                        Text="+ Group" 
                        ButtonStyle="ButtonStyle.Info"
                        Click="@(_ => AddGroup())" />
        </RadzenStack>
    </RadzenStack>
</RadzenFieldset>
