@using AdventureGame.Engine.Models
@using AdventureGame.Engine.Runtime
@using AdventureGame.Engine.Models.Elements

<RadzenCard Style="margin-top: 16px;">
    <RadzenStack Gap="12">
        <RadzenText TextStyle="TextStyle.H6">Session State Inspector</RadzenText>
        
        @if (Session == null)
        {
            <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat">
                No session loaded
            </RadzenAlert>
        }
        else
        {
            <RadzenTabs>
                <Tabs>
                    <RadzenTabsItem Text="Elements">
                        <RadzenTextBox Placeholder="Filter elements..." @bind-Value="filterText" Style="width: 100%; margin-bottom: 8px;" />
                        
                        <RadzenDataGrid Data="@GetFilteredElements()" TItem="GameElement" AllowFiltering="false" AllowPaging="true" PageSize="10">
                            <Columns>
                                <RadzenDataGridColumn TItem="GameElement" Property="Name" Title="Name" Width="200px" />
                                <RadzenDataGridColumn TItem="GameElement" Property="Kind" Title="Type" Width="100px" />
                                <RadzenDataGridColumn TItem="GameElement" Title="Current State" Width="150px">
                                    <Template Context="element">
                                        @(element.Properties.TryGetValue("CurrentState", out var cs) ? cs : element.DefaultState)
                                    </Template>
                                </RadzenDataGridColumn>
                                <RadzenDataGridColumn TItem="GameElement" Title="Attributes" Width="200px">
                                    <Template Context="element">
                                        <RadzenText TextStyle="TextStyle.Caption">
                                            @string.Join(", ", element.Attributes.Select(kvp => $"{kvp.Key}={kvp.Value}"))
                                        </RadzenText>
                                    </Template>
                                </RadzenDataGridColumn>
                                <RadzenDataGridColumn TItem="GameElement" Title="Actions">
                                    <Template Context="element">
                                        <RadzenButton Icon="visibility" Size="ButtonSize.Small" 
                                                      Click="@(() => ShowElementDetails(element))" 
                                                      Text="Details" />
                                    </Template>
                                </RadzenDataGridColumn>
                            </Columns>
                        </RadzenDataGrid>
                    </RadzenTabsItem>
                    
                    <RadzenTabsItem Text="Hierarchy">
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="16" Style="width: 100%;">
                            <!-- Left: Tree View -->
                            <div style="flex: 1; min-width: 300px;">
                                <RadzenTree Data="@GetHierarchyData()" 
                                           Style="width: 100%; height: 500px; overflow-y: auto;"
                                           @bind-Value="selectedHierarchyValue"
                                           @bind-ExpandedKeys="expandedKeys"
                                           AllowClear="false"
                                           Change="@OnHierarchyNodeSelected">
                                    <RadzenTreeLevel TextProperty="Text" 
                                                    ChildrenProperty="Children" 
                                                    HasChildren="@(e => (e as HierarchyNode)?.Children?.Any() == true)" />
                                </RadzenTree>
                            </div>

                            <!-- Right: Summary Panel -->
                            @if (selectedElement != null)
                            {
                                <RadzenCard Style="flex: 1; min-width: 300px; max-width: 400px;">
                                    <RadzenStack Gap="12">
                                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                            <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">@selectedElement.Name</RadzenText>
                                            <RadzenBadge Text="@selectedElement.Kind" />
                                        </RadzenStack>

                                        <!-- Compact Summary -->
                                        <RadzenStack Gap="8">
                                            <RadzenFormField Text="Current State" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenText TextStyle="TextStyle.Body2">
                                                        @(selectedElement.Properties.TryGetValue("CurrentState", out var cs) ? cs : selectedElement.DefaultState)
                                                    </RadzenText>
                                                </ChildContent>
                                            </RadzenFormField>

                                            @if (selectedElement.Description?.Length > 0)
                                            {
                                                <RadzenFormField Text="Description" Variant="Variant.Outlined">
                                                    <ChildContent>
                                                        <div style="max-height: 60px; overflow: hidden; position: relative;" 
                                                             title="@selectedElement.Description">
                                                            <RadzenText TextStyle="TextStyle.Caption" Style="opacity: 0.8;">
                                                                @selectedElement.Description
                                                            </RadzenText>
                                                        </div>
                                                    </ChildContent>
                                                </RadzenFormField>
                                            }

                                            @if (selectedElement.Attributes.Any())
                                            {
                                                <RadzenFormField Text="Attributes" Variant="Variant.Outlined">
                                                    <ChildContent>
                                                        <div style="max-height: 60px; overflow: hidden; position: relative;" title="@string.Join(", ", selectedElement.Attributes.Select(kvp => $"{kvp.Key}={kvp.Value}"))">
                                                            <RadzenText TextStyle="TextStyle.Caption" Style="font-family: monospace;">
                                                                @string.Join(", ", selectedElement.Attributes.Take(3).Select(kvp => $"{kvp.Key}={kvp.Value}"))
                                                                @if (selectedElement.Attributes.Count > 3) { <text>...</text> }
                                                            </RadzenText>
                                                        </div>
                                                    </ChildContent>
                                                </RadzenFormField>
                                            }

                                            @if (selectedElement.Properties.Any())
                                            {
                                                <RadzenFormField Text="Properties" Variant="Variant.Outlined">
                                                    <ChildContent>
                                                        <div style="max-height: 60px; overflow: hidden; position: relative;" title="@string.Join(", ", selectedElement.Properties.Select(kvp => $"{kvp.Key}={kvp.Value}"))">
                                                            <RadzenText TextStyle="TextStyle.Caption" Style="font-family: monospace;">
                                                                @string.Join(", ", selectedElement.Properties.Take(3).Select(kvp => $"{kvp.Key}={kvp.Value}"))
                                                                @if (selectedElement.Properties.Count > 3) { <text>...</text> }
                                                            </RadzenText>
                                                        </div>
                                                    </ChildContent>
                                                </RadzenFormField>
                                            }

                                            @if (selectedElement.Flags.Any())
                                            {
                                                <RadzenFormField Text="Flags" Variant="Variant.Outlined">
                                                    <ChildContent>
                                                        <RadzenStack Orientation="Orientation.Horizontal" Gap="4" Wrap="FlexWrap.Wrap">
                                                            @foreach (var flag in selectedElement.Flags.Take(5))
                                                            {
                                                                <RadzenBadge Text="@flag.Key" 
                                                                            BadgeStyle="@(flag.Value ? BadgeStyle.Success : BadgeStyle.Secondary)" 
                                                                            Variant="Variant.Flat" />
                                                            }
                                                            @if (selectedElement.Flags.Count > 5)
                                                            {
                                                                <RadzenBadge Text="..." BadgeStyle="BadgeStyle.Light" />
                                                            }
                                                        </RadzenStack>
                                                    </ChildContent>
                                                </RadzenFormField>
                                            }

                                            @if (selectedElement is Exit exit)
                                            {
                                                <RadzenFormField Text="Direction" Variant="Variant.Outlined">
                                                    <ChildContent>
                                                        <RadzenText TextStyle="TextStyle.Body2">
                                                            @(exit.Direction?.ToString() ?? "Custom")
                                                        </RadzenText>
                                                    </ChildContent>
                                                </RadzenFormField>

                                                @if (exit.TargetExitId != null)
                                                {
                                                    var targetExit = Session.Pack?.Elements.FirstOrDefault(e => e.Id == exit.TargetExitId);
                                                    <RadzenFormField Text="Leads To" Variant="Variant.Outlined">
                                                        <ChildContent>
                                                            <RadzenText TextStyle="TextStyle.Body2">
                                                                @(targetExit?.Name ?? "Unknown")
                                                            </RadzenText>
                                                        </ChildContent>
                                                    </RadzenFormField>
                                                }
                                            }

                                            @if (selectedElement is Player player)
                                            {
                                                var playerLocation = allElements?.FirstOrDefault(e => e.Id == player.ParentId);
                                                @if (playerLocation != null)
                                                {
                                                    <RadzenFormField Text="Location" Variant="Variant.Outlined">
                                                        <ChildContent>
                                                            <RadzenText TextStyle="TextStyle.Body2">
                                                                @playerLocation.Name (@playerLocation.Kind)
                                                            </RadzenText>
                                                        </ChildContent>
                                                    </RadzenFormField>
                                                }
                                            }
                                        </RadzenStack>

                                        <!-- Action Buttons -->
                                        <RadzenStack Orientation="Orientation.Horizontal" Gap="8" Style="margin-top: 12px;">
                                            <RadzenButton Icon="visibility" Text="Full Details" 
                                                        Size="ButtonSize.Small" 
                                                        ButtonStyle="ButtonStyle.Light"
                                                        Click="@(() => ShowElementDetails(selectedElement))" />
                                            @if (OnRequestEdit.HasDelegate)
                                            {
                                                <RadzenButton Icon="edit" Text="Edit" 
                                                            Size="ButtonSize.Small" 
                                                            ButtonStyle="ButtonStyle.Primary"
                                                            Click="@(() => OnRequestEdit.InvokeAsync(selectedElement))" />
                                            }
                                        </RadzenStack>
                                    </RadzenStack>
                                </RadzenCard>
                            }
                        </RadzenStack>
                    </RadzenTabsItem>
                    
                    <RadzenTabsItem Text="Session Info">
                        <RadzenStack Gap="8">
                            <RadzenFormField Text="Current Player">
                                <RadzenText>@(Session.Player?.Name ?? "None")</RadzenText>
                            </RadzenFormField>
                            
                            <RadzenFormField Text="Current Scene">
                                <RadzenText>@(Session.CurrentScene?.Name ?? "None")</RadzenText>
                            </RadzenFormField>
                            
                            <RadzenFormField Text="Current Target">
                                <RadzenText>@(Session.CurrentTarget?.Name ?? "None")</RadzenText>
                            </RadzenFormField>
                            
                            <RadzenFormField Text="Round Count">
                                <RadzenText>@Session.History.Count</RadzenText>
                            </RadzenFormField>
                        </RadzenStack>
                    </RadzenTabsItem>
                </Tabs>
            </RadzenTabs>
        }
    </RadzenStack>
</RadzenCard>

@code {
    [Parameter]
    public GameSession? Session { get; set; }

    [Parameter]
    public EventCallback<GameElement> OnRequestEdit { get; set; }

    [Inject]
    private DialogService DialogService { get; set; } = null!;

    private string filterText = string.Empty;
    private object? selectedHierarchyValue;
    private GameElement? selectedElement;
    private ICollection<object> expandedKeys = new HashSet<object>();
    private List<GameElement>? allElements;

    private IEnumerable<GameElement> GetFilteredElements()
    {
        if (Session?.Pack?.Elements == null)
            return Enumerable.Empty<GameElement>();

        var elements = Session.Pack.Elements.AsEnumerable();

        if (!string.IsNullOrWhiteSpace(filterText))
        {
            var filter = filterText.ToLowerInvariant();
            elements = elements.Where(e =>
                e.Name.ToLowerInvariant().Contains(filter) ||
                e.Kind.ToLowerInvariant().Contains(filter) ||
                e.Aliases.Any(a => a.ToLowerInvariant().Contains(filter))
            );
        }

        return elements;
    }

    private IEnumerable<HierarchyNode> GetHierarchyData()
    {
        if (Session?.Pack?.Elements == null)
            return Enumerable.Empty<HierarchyNode>();

        var result = new List<HierarchyNode>();
        allElements = Session.Pack.Elements;
        var player = allElements.OfType<Player>().FirstOrDefault();

        // Build hierarchy: Levels -> Scenes -> Exits/Items/NPCs/Player -> Contained Items
        var levels = allElements.OfType<Level>().ToList();
        foreach (var level in levels)
        {
            var levelNode = new HierarchyNode
            {
                Text = $"📁 {level.Name}",
                Element = level,
                Children = new List<HierarchyNode>()
            };

            var scenes = allElements.OfType<Scene>()
                .Where(s => s.ParentId == level.Id)
                .ToList();

            foreach (var scene in scenes)
            {
                var sceneNode = new HierarchyNode
                {
                    Text = $"🗺️ {scene.Name}",
                    Element = scene,
                    Children = new List<HierarchyNode>()
                };

                // Add exits from this scene
                var exits = allElements.OfType<Exit>()
                    .Where(e => e.ParentId == scene.Id)
                    .ToList();

                foreach (var exit in exits)
                {
                    var targetInfo = "";
                    if (exit.TargetExitId != null)
                    {
                        var targetExit = allElements.FirstOrDefault(e => e.Id == exit.TargetExitId);
                        if (targetExit != null)
                        {
                            var targetScene = allElements.FirstOrDefault(s => s.Id == targetExit.ParentId);
                            targetInfo = $" → {targetScene?.Name ?? "Unknown"}";
                        }
                    }

                    var directionText = exit.Direction?.ToString() ?? "Custom";
                    var exitNode = new HierarchyNode 
                    { 
                        Text = $"🚪 {exit.Name} ({directionText}){targetInfo}",
                        Element = exit
                    };
                    sceneNode.Children.Add(exitNode);
                }

                // Add items, NPCs, and the Player if they are in this scene
                var directItems = allElements.OfType<Item>()
                    .Where(i => i.ParentId == scene.Id)
                    .ToList();

                var npcs = allElements.OfType<Npc>()
                    .Where(n => n.ParentId == scene.Id)
                    .ToList();

                if (player != null && player.ParentId == scene.Id)
                {
                    var playerNode = new HierarchyNode
                    {
                        Text = $"🎮 {player.Name} (Player)",
                        Element = player,
                        Children = new List<HierarchyNode>()
                    };
                    var playerItems = allElements.OfType<Item>().Where(i => i.ParentId == player.Id).ToList();
                    foreach (var item in playerItems)
                    {
                        playerNode.Children.Add(BuildItemNode(item, allElements));
                    }
                    sceneNode.Children.Add(playerNode);
                }

                foreach (var item in directItems)
                {
                    var itemNode = BuildItemNode(item, allElements);
                    sceneNode.Children.Add(itemNode);
                }

                foreach (var npc in npcs)
                {
                    var npcNode = new HierarchyNode 
                    { 
                        Text = $"👤 {npc.Name}",
                        Element = npc
                    };
                    
                    var containedItems = allElements.OfType<Item>()
                        .Where(i => i.ParentId == npc.Id)
                        .ToList();
                    
                    if (containedItems.Any())
                    {
                        npcNode.Children = new List<HierarchyNode>();
                        foreach (var item in containedItems)
                        {
                            var itemNode = BuildItemNode(item, allElements);
                            npcNode.Children.Add(itemNode);
                        }
                    }
                    
                    sceneNode.Children.Add(npcNode);
                }

                levelNode.Children.Add(sceneNode);
            }

            result.Add(levelNode);
        }

        // Add "Off Map" node for elements without a parent or with null position
        var offMapNode = BuildOffMapNode(allElements);
        if (offMapNode.Children?.Any() == true)
        {
            result.Add(offMapNode);
        }

        return result;
    }

    private HierarchyNode BuildOffMapNode(List<GameElement> allElements)
    {
        var offMapNode = new HierarchyNode
        {
            Text = "📍 Off Map",
            Children = new List<HierarchyNode>()
        };

        var player = allElements.OfType<Player>().FirstOrDefault();
        var validParents = new HashSet<ElementId>(
            allElements.Where(e => e is Scene or Npc or Item or Player).Select(e => e.Id)
        );

        // Find scenes without a valid parent or position
        var offMapScenes = allElements.OfType<Scene>()
            .Where(s => s.ParentId == null || s.Position == null)
            .ToList();

        foreach (var scene in offMapScenes)
        {
            var sceneNode = new HierarchyNode
            {
                Text = $"🗺️ {scene.Name} (unmapped)",
                Element = scene,
                Children = new List<HierarchyNode>()
            };

            var items = allElements.OfType<Item>().Where(i => i.ParentId == scene.Id).ToList();
            var npcs = allElements.OfType<Npc>().Where(n => n.ParentId == scene.Id).ToList();

            foreach (var item in items)
            {
                sceneNode.Children.Add(BuildItemNode(item, allElements));
            }

            foreach (var npc in npcs)
            {
                var npcNode = new HierarchyNode { Text = $"👤 {npc.Name}", Element = npc };
                var npcItems = allElements.OfType<Item>().Where(i => i.ParentId == npc.Id).ToList();
                if (npcItems.Any())
                {
                    npcNode.Children = npcItems.Select(i => BuildItemNode(i, allElements)).ToList();
                }
                sceneNode.Children.Add(npcNode);
            }

            offMapNode.Children.Add(sceneNode);
        }

        // Find orphaned items (not in any scene, NPC, or player)
        var orphanedItems = allElements.OfType<Item>()
            .Where(i => i.ParentId == null || !validParents.Contains(i.ParentId.Value))
            .ToList();

        foreach (var item in orphanedItems)
        {
            offMapNode.Children.Add(BuildItemNode(item, allElements));
        }

        // Find orphaned NPCs
        var orphanedNpcs = allElements.OfType<Npc>()
            .Where(n => n.ParentId == null || !allElements.Any(s => s.Id == n.ParentId))
            .ToList();

        foreach (var npc in orphanedNpcs)
        {
            var npcNode = new HierarchyNode { Text = $"👤 {npc.Name} (orphaned)", Element = npc };
            var npcItems = allElements.OfType<Item>().Where(i => i.ParentId == npc.Id).ToList();
            if (npcItems.Any())
            {
                npcNode.Children = npcItems.Select(i => BuildItemNode(i, allElements)).ToList();
            }
            offMapNode.Children.Add(npcNode);
        }
        
        // Add player if they are off-map
        if (player != null && (player.ParentId == null || !validParents.Contains(player.ParentId.Value)))
        {
             var playerNode = new HierarchyNode
            {
                Text = $"🎮 {player.Name} (Player, unmapped)",
                Element = player,
                Children = new List<HierarchyNode>()
            };
            var playerItems = allElements.OfType<Item>().Where(i => i.ParentId == player.Id).ToList();
            foreach (var item in playerItems)
            {
                playerNode.Children.Add(BuildItemNode(item, allElements));
            }
            offMapNode.Children.Add(playerNode);
        }

        return offMapNode;
    }

    private HierarchyNode BuildItemNode(Item item, List<GameElement> allElements)
    {
        var itemNode = new HierarchyNode 
        { 
            Text = $"📦 {item.Name}",
            Element = item
        };

        var containedItems = allElements.OfType<Item>()
            .Where(i => i.ParentId == item.Id)
            .ToList();

        if (containedItems.Any())
        {
            itemNode.Children = new List<HierarchyNode>();
            foreach (var containedItem in containedItems)
            {
                var childNode = BuildItemNode(containedItem, allElements);
                itemNode.Children.Add(childNode);
            }
        }

        return itemNode;
    }

    private void OnHierarchyNodeSelected(TreeEventArgs args)
    {
        if (args.Value is HierarchyNode node)
        {
            selectedElement = node.Element;
            if (node.Children?.Any() == true && !expandedKeys.Contains(node))
            {
                expandedKeys.Add(node);
            }
        }
    }

    private async Task ShowElementDetails(GameElement element)
    {
        var parameters = new Dictionary<string, object>
        {
            { "Element", element }
        };

        await DialogService.OpenAsync<ElementDetailsDialog>($"Details: {element.Name}",
            parameters,
            new DialogOptions { Width = "600px", Height = "500px" });
    }

    private class HierarchyNode
    {
        public string Text { get; set; } = string.Empty;
        public GameElement? Element { get; set; }
        public List<HierarchyNode>? Children { get; set; }

        public override bool Equals(object? obj)
        {
            if (obj is not HierarchyNode other) return false;
            if (Element != null && other.Element != null)
            {
                return Element.Id == other.Element.Id;
            }
            return Text == other.Text;
        }

        public override int GetHashCode()
        {
            return Element?.Id.GetHashCode() ?? Text.GetHashCode();
        }
    }
}
