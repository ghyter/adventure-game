@using AdventureGame.Engine.DSL
@using AdventureGame.Engine.DSL.Parser
@inject NotificationService NotificationService

<RadzenStack Gap="8">
    <RadzenTextArea @bind-Value="conditionText" 
                    Placeholder="Enter condition DSL (e.g., player is target and target.state is open)" 
                    Rows="3" 
                    Style="width: 100%; font-family: monospace;"
                    Change="@OnConditionChanged" />
    
    @if (parseResult != null && !parseResult.Success)
    {
        <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Variant.Flat" Shade="Shade.Lighter">
            <RadzenStack Gap="4">
                <RadzenText TextStyle="TextStyle.Subtitle2" Style="font-weight: 600;">Parse Errors:</RadzenText>
                @foreach (var error in parseResult.Errors)
                {
                    <RadzenText TextStyle="TextStyle.Body2" Style="font-family: monospace;">
                        [@error.Severity] @error.Message [position @error.StartIndex..@error.EndIndex]
                    </RadzenText>
                }
            </RadzenStack>
        </RadzenAlert>
    }
    else if (parseResult != null && parseResult.Success)
    {
        <RadzenAlert AlertStyle="AlertStyle.Success" Variant="Variant.Flat" Shade="Shade.Lighter">
            <RadzenText TextStyle="TextStyle.Body2">✓ Condition parsed successfully</RadzenText>
        </RadzenAlert>
    }
</RadzenStack>

@code {
    private string conditionText = string.Empty;
    private DslParseResult? parseResult;
    private DslParser parser = new DslParser();

    [Parameter]
    public string Value
    {
        get => conditionText;
        set
        {
            if (conditionText != value)
            {
                conditionText = value ?? string.Empty;
                ValidateCondition();
            }
        }
    }

    [Parameter]
    public EventCallback<ConditionInputResult> OnParsed { get; set; }

    private void OnConditionChanged()
    {
        ValidateCondition();
    }

    private void ValidateCondition()
    {
        if (string.IsNullOrWhiteSpace(conditionText))
        {
            parseResult = null;
            _ = OnParsed.InvokeAsync(new ConditionInputResult 
            { 
                ConditionText = conditionText, 
                ParseResult = null 
            });
            return;
        }

        parseResult = parser.Parse(conditionText);

        _ = OnParsed.InvokeAsync(new ConditionInputResult 
        { 
            ConditionText = conditionText, 
            ParseResult = parseResult 
        });
    }
}
