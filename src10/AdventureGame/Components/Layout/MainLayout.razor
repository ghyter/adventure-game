@inherits LayoutComponentBase
@using System.Diagnostics
@inject AdventureGame.Editor.Services.CurrentGameService _currentGame
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject NavigationManager Navigation


<RadzenComponents />

<!-- ========================================================= -->
<!-- =================== GLOBAL HEADER (Ribbon 1) ============ -->
<!-- ========================================================= -->
<RadzenRow Class="ribbon-1" AlignItems="AlignItems.Center">
    <!-- Left: Product Title -->
    <RadzenColumn Size="3">
        <RadzenText Style="font-size:1.4rem; font-weight:600; color:white;">
            Adventure Game Editor
        </RadzenText>
    </RadzenColumn>

    <!-- Center: Global Navigation -->
    <RadzenColumn Size="6">
        <RadzenStack Orientation="Orientation.Horizontal"
                     Gap="20"
                     AlignItems="AlignItems.Center"
                     JustifyContent="JustifyContent.Center">
            <RadzenLink Path="/" Text="Home" Style="color:white; font-weight:500;" />
            <RadzenLink Path="/games" Text="Games" Style="color:white; font-weight:500;" />
        </RadzenStack>
    </RadzenColumn>

    <!-- Right: Action Buttons -->
    <RadzenColumn Size="3" Style="text-align:right;">
        @if (_currentGame.HasCurrent)
        {
            <RadzenStack Orientation="Orientation.Horizontal"
                         Gap="8"
                         AlignItems="AlignItems.Center"
                         JustifyContent="JustifyContent.End">

                <RadzenButton Icon="save"
                              Text="Save"
                              ButtonStyle="ButtonStyle.Primary"
                              Size="ButtonSize.Small"
                              Disabled="@(!_currentGame.HasCurrent || !_currentGame.IsDirty)"
                              Click="@(async args => await SaveCurrentAsync())" />

                <RadzenButton Icon="undo"
                              Text="Cancel"
                              ButtonStyle="ButtonStyle.Secondary"
                              Size="ButtonSize.Small"
                              Disabled="@(!_currentGame.HasCurrent || !_currentGame.IsDirty)"
                              Click="@(async args => await CancelCurrentAsync())" />
            </RadzenStack>
        }
    </RadzenColumn>
</RadzenRow>



<!-- ========================================================= -->
<!-- =================== GAME HEADER (Ribbon 2) ============== -->
<!-- ========================================================= -->
@if (_currentGame.HasCurrent)
{
    <RadzenRow class="ribbon-2" AlignItems="AlignItems.Center">

        <!-- LEFT SIDE: Always visible -->
        <RadzenColumn Size="4">
            <RadzenStack Orientation="Orientation.Vertical" Gap="2">

                <RadzenStack Orientation="Orientation.Horizontal"
                             AlignItems="AlignItems.Center"
                             Gap="12">

                    <RadzenText Style="font-size:1.1rem; font-weight:600;">
                        @_currentGame.CurrentPack?.Name
                    </RadzenText>

                    <RadzenText TextStyle="TextStyle.Caption" Style="opacity:0.7;">
                        @_currentGame.CurrentPack?.Version
                    </RadzenText>

                    <RadzenText TextStyle="TextStyle.Caption" Style="opacity:0.6;">
                        @(_currentGame.CurrentPack?.ModifiedAt.ToLocalTime().ToString() ?? "")
                    </RadzenText>

                </RadzenStack>

                @if (ribbonOpen && !string.IsNullOrWhiteSpace(_currentGame.CurrentPack?.Description))
                {
                    <RadzenText TextStyle="TextStyle.Caption" Style="opacity:0.65; max-width:75ch;">
                        @_currentGame.CurrentPack.Description
                    </RadzenText>
                }

            </RadzenStack>
        </RadzenColumn>


        <!-- RIGHT SIDE: NAVIGATION -->
        <RadzenColumn Size="7" Style="text-align:right;">

            @if (ribbonOpen)
            {
                <!-- EXPANDED MODE: Icons + Text -->
                <RadzenStack Orientation="Orientation.Horizontal"
                             AlignItems="AlignItems.Center"
                             Gap="22"
                             JustifyContent="JustifyContent.End">

                    @foreach (var item in NavItems)
                    {
                        <RadzenLink Path="@item.Path" Style="display: flex; align-items: center; gap: 6px;">
                            <RadzenIcon Icon="@item.Icon" Style="font-size: 1.25rem;" />
                            <span>@item.Label</span>
                        </RadzenLink>
                    }
                </RadzenStack>
            }
            else
            {
                <!-- COLLAPSED MODE: Icons only -->
                <RadzenStack Orientation="Orientation.Horizontal"
                             AlignItems="AlignItems.Center"
                             Gap="22"
                             JustifyContent="JustifyContent.End">

                    @foreach (var item in NavItems)
                    {
                        <RadzenLink Path="@item.Path" title="@item.Label">
                            <RadzenIcon Icon="@item.Icon" Style="font-size: 1.25rem;" />
                        </RadzenLink>
                    }
                </RadzenStack>
            }

        </RadzenColumn>


        <!-- RIGHTMOST: Toggle Button -->
        <RadzenColumn Size="1" Style="text-align:right;">
            <RadzenButton Icon="@(ribbonOpen ? "expand_less" : "expand_more")"
                          Size="ButtonSize.Small"
                          ButtonStyle="ButtonStyle.Light"
                          Style="min-width:28px;"
                          Click="@ToggleRibbon" />
        </RadzenColumn>

    </RadzenRow>
}

<!-- ========================================================= -->
<!-- =================== PAGE CONTENT ======================== -->
<!-- ========================================================= -->

<RadzenBody Style="padding: 12px;">
    @Body
</RadzenBody>




<!-- ========================================================= -->
<!-- ========================== CSS ========================== -->
<!-- ========================================================= -->
<style>
    /* MAIN HEADER BAR */
    .ribbon-1 {
        background: var(--rz-primary);
        padding: 10px 14px;
        border-bottom: 1px solid var(--rz-primary-dark);
        color: white;
    }

    /* GAME HEADER BAR */
    .ribbon-2 {
        background: #fafbfc;
        border-bottom: 1px solid #dcdfe3;
        padding: 10px 18px;
    }


    /* Make the content area wider */
    .rz-body {
        margin: 0 !important;
        padding: 16px !important;
        width: 100% !important;
    }

    .rz-content {
        margin: 0 !important;
        padding: 0 !important;
    }

    a {
        color: inherit !important;
        font-weight: 500;
        text-decoration: none;
    }

    .rz-text {
        white-space: nowrap;
    }
</style>




<!-- ========================================================= -->
<!-- ====================== CODE-BEHIND ======================= -->
<!-- ========================================================= -->
@code {
    private const string RibbonStateKey = "adventure_ribbon_open";

    protected override void OnInitialized()
    {
        _currentGame.OnChange += StateHasChanged;
        
        // Restore ribbon state from MAUI Preferences
        ribbonOpen = Preferences.Default.Get(RibbonStateKey, true);
    }

    public void Dispose()
    {
        _currentGame.OnChange -= StateHasChanged;
    }


    bool ribbonOpen = true;

    void ToggleRibbon()
    {
        ribbonOpen = !ribbonOpen;
        
        // Persist the ribbon state using MAUI Preferences
        Preferences.Default.Set(RibbonStateKey, ribbonOpen);
        
        StateHasChanged();
    }

    private void NavigateToTestingHub()
    {
        Navigation.NavigateTo("/tools/hub");
    }

    private async Task SaveCurrentAsync()
    {
        if (!_currentGame.HasCurrent) return;

        var beforeCount = _currentGame.CurrentPack?.Elements?.Count ?? 0;

        var ok = await _currentGame.SaveCurrentPackAsync();
        if (ok)
        {
            var afterCount = _currentGame.CurrentPack?.Elements?.Count ?? 0;
            if (beforeCount != afterCount)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Warning,
                    Summary = "Saved (inconsistent)",
                    Detail = $"Saved but element count changed: before={beforeCount}, after={afterCount}",
                    Duration = 5000
                });
            }
            else
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Saved",
                    Detail = $"GamePack '{_currentGame.CurrentPack?.Name}' saved ({afterCount} elements).",
                    Duration = 3000
                });
            }
        }
        else
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Save failed",
                Detail = "Could not save GamePack to IndexedDB.",
                Duration = 5000
            });
        }

        await InvokeAsync(StateHasChanged);
    }

    private async Task CancelCurrentAsync()
    {
        if (!_currentGame.HasCurrent) return;

        var ok = await _currentGame.ResetCurrentPackAsync();
        if (ok)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Info,
                Summary = "Reverted",
                Detail = "Reverted to last saved version.",
                Duration = 3000
            });
        }
        else
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Revert failed",
                Detail = "Could not reload saved GamePack from storage.",
                Duration = 5000
            });
        }

        await InvokeAsync(StateHasChanged);
    }

    record NavItem(string Icon, string Path, string Label);

    List<NavItem> NavItems = new()
{
    new("map", "/gamepack/map", "Map"),
    new("widgets", "/gamepack/elements", "Elements"),
    new("rule", "/gamepack/actions", "Actions"),
    new("dashboard", "/tools/hub", "Testing Hub")
};

}
