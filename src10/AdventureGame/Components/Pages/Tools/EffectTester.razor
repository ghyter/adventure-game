@page "/tools/effects"
@using AdventureGame.Engine.Verbs
@using AdventureGame.Engine.Runtime
@using AdventureGame.Engine.Services
@using AdventureGame.Components.SessionAudit
@inject AdventureGame.Editor.Services.CurrentGameService CurrentGameService
@inject NotificationService NotificationService

<PageTitle>Effect Tester</PageTitle>

<RadzenStack Gap="8">
    <RadzenText TextStyle="TextStyle.H5" Style="margin: 0;">? Effect Tester</RadzenText>

    @if (!CurrentGameService.HasCurrent)
    {
        <RadzenAlert AlertStyle="AlertStyle.Warning" Variant="Variant.Flat">
            Please load a GamePack first.
        </RadzenAlert>
    }
    else
    {
        <!-- Effect Input Section -->
        <RadzenCard Style="padding: 16px;">
            <RadzenStack Gap="12">
                <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">Effect Definition</RadzenText>

                <RadzenFormField Text="Min Roll" Variant="Variant.Outlined">
                    <RadzenNumeric @bind-Value="@effectMin" 
                                 TValue="int"
                                 Min="0" Max="20"
                                 Style="width: 100%;" />
                </RadzenFormField>

                <RadzenFormField Text="Max Roll" Variant="Variant.Outlined">
                    <RadzenNumeric @bind-Value="@effectMax" 
                                 TValue="int"
                                 Min="0" Max="20"
                                 Style="width: 100%;" />
                </RadzenFormField>

                <RadzenFormField Text="Success Message" Variant="Variant.Outlined">
                    <RadzenTextArea @bind-Value="@effectSuccessText" 
                                  Rows="2"
                                  Style="width: 100%;" />
                </RadzenFormField>

                <RadzenFormField Text="Failure Message" Variant="Variant.Outlined">
                    <RadzenTextArea @bind-Value="@effectFailureText" 
                                  Rows="2"
                                  Style="width: 100%;" />
                </RadzenFormField>

                <RadzenFormField Text="Action" Variant="Variant.Outlined">
                    <RadzenTextBox @bind-Value="@effectAction" 
                                 Style="width: 100%;"
                                 Placeholder="e.g., ChangeState:door:open" />
                </RadzenFormField>
            </RadzenStack>
        </RadzenCard>

        <!-- Context Selection Section -->
        <RadzenCard Style="padding: 16px;">
            <RadzenStack Gap="12">
                <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">Execution Context</RadzenText>

                <RadzenFormField Text="Current Player" Variant="Variant.Outlined">
                    <RadzenDropDown @bind-Value="@selectedPlayerId"
                                  Data="@GetAvailablePlayers()"
                                  TextProperty="Name"
                                  ValueProperty="Id"
                                  AllowClear="true"
                                  Placeholder="Select player..."
                                  Style="width: 100%;"
                                  Change="@OnPlayerChanged" />
                </RadzenFormField>

                <RadzenFormField Text="Target 1" Variant="Variant.Outlined">
                    <RadzenDropDown @bind-Value="@selectedTarget1Id"
                                  Data="@GetAvailableElements()"
                                  TextProperty="Name"
                                  ValueProperty="Id"
                                  AllowClear="true"
                                  Placeholder="Select target..."
                                  Style="width: 100%;"
                                  Change="@OnContextChanged" />
                </RadzenFormField>

                <RadzenFormField Text="Target 2" Variant="Variant.Outlined">
                    <RadzenDropDown @bind-Value="@selectedTarget2Id"
                                  Data="@GetAvailableElements()"
                                  TextProperty="Name"
                                  ValueProperty="Id"
                                  AllowClear="true"
                                  Placeholder="Select target..."
                                  Style="width: 100%;"
                                  Change="@OnContextChanged" />
                </RadzenFormField>

                <RadzenFormField Text="Current Scene" Variant="Variant.Outlined">
                    <RadzenDropDown @bind-Value="@selectedSceneId"
                                  Data="@GetAvailableScenes()"
                                  TextProperty="Name"
                                  ValueProperty="Id"
                                  AllowClear="true"
                                  Placeholder="Select scene..."
                                  Style="width: 100%;"
                                  Change="@OnContextChanged" />
                </RadzenFormField>
            </RadzenStack>
        </RadzenCard>

        <!-- Execution Section -->
        <RadzenCard Style="padding: 16px;">
            <RadzenStack Gap="12" Orientation="Orientation.Horizontal">
                <RadzenButton Icon="play_arrow" Text="Execute Effect" 
                            ButtonStyle="ButtonStyle.Primary"
                            Click="@ExecuteEffect" />
                <RadzenButton Icon="refresh" Text="Reset" 
                            ButtonStyle="ButtonStyle.Light"
                            Click="@ResetContext" />
            </RadzenStack>
        </RadzenCard>

        <!-- Results Section -->
        @if (lastResult != null)
        {
            <RadzenCard Style="@GetResultStyle()">
                <RadzenStack Gap="8">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="8">
                        @if (lastResult.Success)
                        {
                            <RadzenIcon Icon="check_circle" Style="color: var(--rz-success); font-size: 24px;" />
                            <RadzenText TextStyle="TextStyle.H6" Style="margin: 0; color: var(--rz-success);">Success</RadzenText>
                        }
                        else
                        {
                            <RadzenIcon Icon="cancel" Style="color: var(--rz-danger); font-size: 24px;" />
                            <RadzenText TextStyle="TextStyle.H6" Style="margin: 0; color: var(--rz-danger);">Failed</RadzenText>
                        }
                    </RadzenStack>

                    <RadzenText TextStyle="TextStyle.Body2">
                        <strong>Message:</strong> @(lastResult.Success ? lastResult.SuccessText : lastResult.FailureText)
                    </RadzenText>

                    @if (!string.IsNullOrWhiteSpace(lastResult.RollResult))
                    {
                        <RadzenText TextStyle="TextStyle.Body2">
                            <strong>Roll:</strong> @lastResult.RollResult
                        </RadzenText>
                    }

                    @if (!string.IsNullOrWhiteSpace(lastResult.ActionApplied))
                    {
                        <RadzenText TextStyle="TextStyle.Body2">
                            <strong>Action Applied:</strong> @lastResult.ActionApplied
                        </RadzenText>
                    }
                </RadzenStack>
            </RadzenCard>
        }

        <!-- Session Audit -->
        <SessionAudit Session="@sandboxSession" />
    }
</RadzenStack>

@code {
    private GameSession? sandboxSession;
    private IGameSessionFactory sessionFactory = new GameSessionFactory();

    private int effectMin = 0;
    private int effectMax = 0;
    private string effectSuccessText = "";
    private string effectFailureText = "";
    private string effectAction = "";

    private object? selectedPlayerId = null;
    private object? selectedTarget1Id = null;
    private object? selectedTarget2Id = null;
    private object? selectedSceneId = null;

    private EffectTestResult? lastResult = null;

    protected override void OnInitialized()
    {
        if (CurrentGameService.HasCurrent && CurrentGameService.CurrentPack != null)
        {
            InitializeSandbox();
        }

        CurrentGameService.OnChange += OnGamePackChanged;
    }

    private void OnGamePackChanged()
    {
        if (CurrentGameService.HasCurrent && CurrentGameService.CurrentPack != null)
        {
            InitializeSandbox();
        }
        else
        {
            sandboxSession = null;
        }
        StateHasChanged();
    }

    private void InitializeSandbox()
    {
        if (CurrentGameService.CurrentPack == null) return;

        try
        {
            sandboxSession = sessionFactory.CreateSandboxSession(CurrentGameService.CurrentPack);
            
            // Set default player
            if (sandboxSession.Player != null)
            {
                selectedPlayerId = sandboxSession.Player.Id;
            }

            // Set default scene
            if (sandboxSession.CurrentScene != null)
            {
                selectedSceneId = sandboxSession.CurrentScene.Id;
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage 
            { 
                Severity = NotificationSeverity.Error, 
                Summary = "Init Error", 
                Detail = ex.Message, 
                Duration = 3000 
            });
        }
    }

    private List<AdventureGame.Engine.Models.GameElement> GetAvailablePlayers()
    {
        if (sandboxSession?.Elements == null) return new();
        return sandboxSession.Elements
            .Where(e => e.Kind == "player")
            .ToList();
    }

    private List<AdventureGame.Engine.Models.GameElement> GetAvailableElements()
    {
        if (sandboxSession?.Elements == null) return new();
        return sandboxSession.Elements.ToList();
    }

    private List<AdventureGame.Engine.Models.GameElement> GetAvailableScenes()
    {
        if (sandboxSession?.Elements == null) return new();
        return sandboxSession.Elements
            .Where(e => e.Kind == "scene")
            .ToList();
    }

    private void OnPlayerChanged()
    {
        if (selectedPlayerId != null && sandboxSession != null)
        {
            if (selectedPlayerId is AdventureGame.Engine.Models.ElementId playerId)
            {
                sandboxSession.Player = sandboxSession.Elements
                    .FirstOrDefault(e => e.Id == playerId);
            }
        }
    }

    private void OnContextChanged()
    {
        if (selectedSceneId != null && sandboxSession != null)
        {
            if (selectedSceneId is AdventureGame.Engine.Models.ElementId sceneId)
            {
                sandboxSession.CurrentScene = sandboxSession.Elements
                    .OfType<AdventureGame.Engine.Models.Elements.Scene>()
                    .FirstOrDefault(s => s.Id == sceneId);
            }
        }
        StateHasChanged();
    }

    private void ExecuteEffect()
    {
        if (sandboxSession == null)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = "No Session",
                Detail = "Initialize a sandbox session first",
                Duration = 3000
            });
            return;
        }

        try
        {
            // Create the effect
            var effect = new VerbEffect
            {
                Min = effectMin,
                Max = effectMax,
                SuccessText = effectSuccessText,
                FailureText = effectFailureText,
                Action = effectAction
            };

            // Determine success
            bool success;
            string rollResult = "";

            if (effectMin == 0 && effectMax == 0)
            {
                // Always succeeds
                success = true;
                rollResult = "Auto-success (no roll)";
            }
            else
            {
                // Roll d20
                var random = new Random();
                int roll = random.Next(1, 21);
                rollResult = $"Rolled {roll} (range {effectMin}-{effectMax})";

                if (roll == 1)
                {
                    success = false;
                }
                else if (roll == 20)
                {
                    success = true;
                }
                else
                {
                    success = roll >= effectMin && roll <= effectMax;
                }
            }

            lastResult = new EffectTestResult
            {
                Success = success,
                SuccessText = effectSuccessText,
                FailureText = effectFailureText,
                RollResult = rollResult,
                ActionApplied = effectAction
            };

            NotificationService.Notify(new NotificationMessage
            {
                Severity = success ? NotificationSeverity.Success : NotificationSeverity.Warning,
                Summary = success ? "Effect Succeeded" : "Effect Failed",
                Detail = success ? effectSuccessText : effectFailureText,
                Duration = 3000
            });
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Execution Error",
                Detail = ex.Message,
                Duration = 3000
            });
        }
    }

    private void ResetContext()
    {
        InitializeSandbox();
        lastResult = null;
        effectMin = 0;
        effectMax = 0;
        effectSuccessText = "";
        effectFailureText = "";
        effectAction = "";
        StateHasChanged();
    }

    private string GetResultStyle()
    {
        if (lastResult == null) return "";
        var bgColor = lastResult.Success ? "var(--rz-success-lighter)" : "var(--rz-danger-lighter)";
        return $"padding: 16px; background: {bgColor}; border-radius: 4px;";
    }

    public void Dispose()
    {
        CurrentGameService.OnChange -= OnGamePackChanged;
    }

    private class EffectTestResult
    {
        public bool Success { get; set; }
        public string SuccessText { get; set; } = "";
        public string FailureText { get; set; } = "";
        public string RollResult { get; set; } = "";
        public string ActionApplied { get; set; } = "";
    }
}
