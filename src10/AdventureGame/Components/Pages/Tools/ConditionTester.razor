@page "/tools/conditions"
@using AdventureGame.Engine.Models
@using AdventureGame.Engine.Runtime
@using AdventureGame.Engine.Services
@using AdventureGame.Engine.DSL
@using AdventureGame.Engine.DSL.Evaluation
@using AdventureGame.Components.Rules
@using AdventureGame.Components.SessionAudit
@using NUlid
@inject AdventureGame.Editor.Services.CurrentGameService CurrentGameService
@inject NotificationService NotificationService
@inject DialogService DialogService

<PageTitle>Condition & Effect Tester</PageTitle>

<RadzenStack Gap="16">
    <RadzenText TextStyle="TextStyle.H4">🧪 Condition & Effect Tester</RadzenText>

    @if (!CurrentGameService.HasCurrent)
    {
        <RadzenAlert AlertStyle="AlertStyle.Warning" Variant="Variant.Flat">
            Please load a GamePack first from the Games page.
        </RadzenAlert>
    }
    else
    {
        <RadzenCard>
            <RadzenStack Gap="12">
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                    <RadzenText TextStyle="TextStyle.H6">Test Conditions</RadzenText>
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="8">
                        <RadzenButton Icon="help_outline" Text="Examples" ButtonStyle="ButtonStyle.Info" Size="ButtonSize.Small" Click="@ShowExamples" />
                        <RadzenButton Icon="add_circle" Text="Add Condition" ButtonStyle="ButtonStyle.Primary" Click="@AddCondition" />
                        <RadzenButton Icon="play_arrow" Text="Evaluate All" ButtonStyle="ButtonStyle.Success" Click="@EvaluateAllConditions" Disabled="@(!hasValidConditions)" />
                        <RadzenButton Icon="refresh" Text="Reset Session" ButtonStyle="ButtonStyle.Light" Click="@ResetSession" />
                    </RadzenStack>
                </RadzenStack>

                <RadzenCard Style="background-color: var(--rz-primary-lighter); padding: 12px;">
                    <RadzenStack Gap="12">
                        <RadzenText TextStyle="TextStyle.Subtitle2" Style="font-weight: 600;">Condition Type & Targets</RadzenText>
                        
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="16" AlignItems="AlignItems.Center">
                            <RadzenFormField Text="Condition Type" Style="min-width: 200px;">
                                <RadzenDropDown @bind-Value="@conditionType" 
                                              Data="@conditionTypes" 
                                              Style="width: 100%;"
                                              Change="@OnConditionTypeChanged" />
                            </RadzenFormField>

                            @if (conditionType == "Verb Condition")
                            {
                                <RadzenFormField Text="Target 1" Style="min-width: 250px;">
                                    <RadzenDropDown @bind-Value="@selectedTarget1Id" 
                                                  Data="@availableElements" 
                                                  TextProperty="Name"
                                                  ValueProperty="Id"
                                                  AllowClear="true"
                                                  Placeholder="Select target element..."
                                                  Style="width: 100%;"
                                                  Change="@OnTarget1Changed" />
                                </RadzenFormField>

                                <RadzenFormField Text="Target 2 (optional)" Style="min-width: 250px;">
                                    <RadzenDropDown @bind-Value="@selectedTarget2Id" 
                                                  Data="@availableElements" 
                                                  TextProperty="Name"
                                                  ValueProperty="Id"
                                                  AllowClear="true"
                                                  Placeholder="Select second target..."
                                                  Disabled="@(selectedTarget1Id == null)"
                                                  Style="width: 100%;" />
                                </RadzenFormField>
                            }
                            else
                            {
                                <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" Style="margin: 0;">
                                    <RadzenText TextStyle="TextStyle.Body2">Trigger conditions evaluate without specific targets.</RadzenText>
                                </RadzenAlert>
                            }
                        </RadzenStack>
                    </RadzenStack>
                </RadzenCard>

                <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" Shade="Shade.Lighter">
                    <RadzenStack Gap="4">
                        <RadzenText TextStyle="TextStyle.Subtitle2" Style="font-weight: 600;">💡 Natural Language Tips:</RadzenText>
                        <RadzenText TextStyle="TextStyle.Body2">• Start conditions with <strong>"when"</strong>: <code>when desk state is closed</code></RadzenText>
                        <RadzenText TextStyle="TextStyle.Body2">• Use item names directly: <code>desk state is closed</code> (automatically infers "item desk")</RadzenText>
                        <RadzenText TextStyle="TextStyle.Body2">• Or be explicit: <code>item desk.state is closed</code> or <code>player is target</code></RadzenText>
                    </RadzenStack>
                </RadzenAlert>

                @if (conditions.Count == 0)
                {
                    <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat">
                        No conditions added yet. Click "Add Condition" to start testing.
                    </RadzenAlert>
                }
                else
                {
                    <RadzenDataList Data="@conditions" TItem="ConditionModel" AllowPaging="false">
                        <Template Context="condition">
                            <RadzenCard Style="margin-bottom: 8px;">
                                <RadzenStack Gap="8">
                                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Start" Gap="8">
                                        <div style="flex: 1;">
                                            <ConditionInput Value="@condition.ConditionText" 
                                                          OnParsed="@((result) => OnConditionParsed(condition, result))" />
                                        </div>
                                        <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" 
                                                      Size="ButtonSize.Small" 
                                                      Click="@(() => RemoveCondition(condition))" />
                                    </RadzenStack>
                                    
                                    @if (condition.EvaluationResult != null)
                                    {
                                        <RadzenAlert AlertStyle="@(condition.EvaluationResult.Value ? AlertStyle.Success : AlertStyle.Danger)" 
                                                     Variant="Variant.Flat">
                                            <RadzenText>
                                                Result: <strong>@(condition.EvaluationResult.Value ? "TRUE" : "FALSE")</strong>
                                            </RadzenText>
                                        </RadzenAlert>
                                    }
                                </RadzenStack>
                            </RadzenCard>
                        </Template>
                    </RadzenDataList>

                    @if (evaluationResults.Count > 0)
                    {
                        <RadzenCard>
                            <RadzenStack Gap="8">
                                <RadzenText TextStyle="TextStyle.H6">Combined Result (AND logic)</RadzenText>
                                <RadzenAlert AlertStyle="@(combinedResult ? AlertStyle.Success : AlertStyle.Danger)" 
                                             Variant="Variant.Flat">
                                    <RadzenText TextStyle="TextStyle.H5">
                                        @(combinedResult ? "✓ ALL CONDITIONS PASS" : "✗ SOME CONDITIONS FAIL")
                                    </RadzenText>
                                </RadzenAlert>
                            </RadzenStack>
                        </RadzenCard>
                    }
                }
            </RadzenStack>
        </RadzenCard>

        <SessionAudit Session="@sandboxSession" />
    }
</RadzenStack>

@code {
    private GameSession? sandboxSession;
    private List<ConditionModel> conditions = new();
    private Dictionary<string, bool> evaluationResults = new();
    private bool combinedResult = false;
    private bool hasValidConditions => conditions.Any(c => c.ParseResult?.Success == true);

    private IGameSessionFactory sessionFactory = new GameSessionFactory();
    private DslService? dslService;

    // Condition type selection
    private string conditionType = "Verb Condition";
    private string[] conditionTypes = ["Verb Condition", "Trigger Condition"];

    // Target selection
    private ElementId? selectedTarget1Id = null;
    private ElementId? selectedTarget2Id = null;
    private List<GameElement> availableElements = new();

    protected override void OnInitialized()
    {
        if (CurrentGameService.HasCurrent && CurrentGameService.CurrentPack != null)
        {
            InitializeSandbox();
        }

        CurrentGameService.OnChange += OnGamePackChanged;
    }

    private void OnGamePackChanged()
    {
        if (CurrentGameService.HasCurrent && CurrentGameService.CurrentPack != null)
        {
            InitializeSandbox();
        }
        else
        {
            sandboxSession = null;
            dslService = null;
            availableElements.Clear();
        }
        StateHasChanged();
    }

    private void InitializeSandbox()
    {
        if (CurrentGameService.CurrentPack == null) return;

        try
        {
            sandboxSession = sessionFactory.CreateSandboxSession(CurrentGameService.CurrentPack);
            
            // Create DSL service with vocabulary from game pack
            var vocab = DslVocabulary.FromGamePack(CurrentGameService.CurrentPack);
            dslService = new DslService(vocab);

            // Populate available elements for target dropdowns
            availableElements = sandboxSession.Elements.ToList();

            NotificationService.Notify(new NotificationMessage 
            { 
                Severity = NotificationSeverity.Success, 
                Summary = "Sandbox Initialized", 
                Detail = $"Created test session with {CurrentGameService.CurrentPack.Elements?.Count ?? 0} elements", 
                Duration = 3000 
            });
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage 
            { 
                Severity = NotificationSeverity.Error, 
                Summary = "Initialization Error", 
                Detail = ex.Message, 
                Duration = 5000 
            });
        }
    }

    private void OnConditionTypeChanged()
    {
        // Clear targets when switching condition type
        if (conditionType == "Trigger Condition")
        {
            selectedTarget1Id = null;
            selectedTarget2Id = null;
        }
    }

    private void OnTarget1Changed()
    {
        // Clear target2 when target1 changes
        if (selectedTarget1Id == null)
        {
            selectedTarget2Id = null;
        }
    }

    private GameElement? FindElement(ElementId? elementId)
    {
        if (elementId == null || sandboxSession == null) return null;
        return sandboxSession.Elements.FirstOrDefault(e => e.Id.Value == elementId.Value.Value);
    }

    private async Task ShowExamples()
    {
        var message = @"
        <strong>Condition Examples:</strong><br/>
        <br/>
        <strong>Natural Language (recommended):</strong><br/>
        • when desk state is closed<br/>
        • when player is in kitchen<br/>
        • if guard health is_less_than 50<br/>
        <br/>
        <strong>Explicit Syntax:</strong><br/>
        • item desk.state is closed<br/>
        • player is target<br/>
        • npc guard.attribute health is_less_than 50<br/>
        • target.state is open<br/>
        • player.visits kitchen is_greater_than 3<br/>
        <br/>
        <strong>Complex Conditions:</strong><br/>
        • (player has key or player has lockpick) and door state is locked<br/>
        • not target.state is broken and target is_visible<br/>
        <br/>
        <strong>Verb vs Trigger Conditions:</strong><br/>
        • <strong>Verb Condition</strong>: Uses selected Target1/Target2 (e.g., 'target.state is open')<br/>
        • <strong>Trigger Condition</strong>: No targets, evaluates global state (e.g., 'player.health is_less_than 50')<br/>
        ";

        await DialogService.Alert(message, "Condition Examples", new AlertOptions { OkButtonText = "Got it!" });
    }

    private void AddCondition()
    {
        conditions.Add(new ConditionModel 
        { 
            Id = Guid.NewGuid().ToString(),
            ConditionText = ""
        });
    }

    private void RemoveCondition(ConditionModel condition)
    {
        conditions.Remove(condition);
        evaluationResults.Remove(condition.Id);
    }

    private void OnConditionParsed(ConditionModel condition, ConditionInputResult result)
    {
        condition.ConditionText = result.ConditionText;
        condition.ParseResult = result.ParseResult;
        condition.EvaluationResult = null; // Clear previous evaluation
    }

    private void EvaluateAllConditions()
    {
        if (sandboxSession == null || dslService == null)
        {
            NotificationService.Notify(new NotificationMessage 
            { 
                Severity = NotificationSeverity.Error, 
                Summary = "No Session", 
                Detail = "Sandbox session not initialized", 
                Duration = 3000 
            });
            return;
        }

        evaluationResults.Clear();
        var allPassed = true;

        foreach (var condition in conditions.Where(c => c.ParseResult?.Success == true))
        {
            try
            {
                // Create evaluation context based on condition type
                GameSessionDslContext ctx;

                if (conditionType == "Verb Condition")
                {
                    var target1 = FindElement(selectedTarget1Id);
                    var target2 = FindElement(selectedTarget2Id);

                    ctx = new GameSessionDslContext(sandboxSession)
                    {
                        Target = target1,
                        Target1 = target1,
                        Target2 = target2
                    };
                }
                else // Trigger Condition
                {
                    ctx = new GameSessionDslContext(sandboxSession)
                    {
                        Target = null,
                        Target1 = null,
                        Target2 = null
                    };
                }

                var result = DslService.Evaluate(condition.ParseResult!.Ast!, ctx);
                
                condition.EvaluationResult = result;
                evaluationResults[condition.Id] = result;
                
                if (!result)
                    allPassed = false;
            }
            catch (Exception ex)
            {
                condition.EvaluationResult = false;
                evaluationResults[condition.Id] = false;
                allPassed = false;

                NotificationService.Notify(new NotificationMessage 
                { 
                    Severity = NotificationSeverity.Error, 
                    Summary = "Evaluation Error", 
                    Detail = ex.Message, 
                    Duration = 4000 
                });
            }
        }

        combinedResult = allPassed && evaluationResults.Count > 0;

        NotificationService.Notify(new NotificationMessage 
        { 
            Severity = combinedResult ? NotificationSeverity.Success : NotificationSeverity.Warning, 
            Summary = "Evaluation Complete", 
            Detail = $"{evaluationResults.Count(kvp => kvp.Value)}/{evaluationResults.Count} conditions passed", 
            Duration = 3000 
        });
    }

    private void ResetSession()
    {
        InitializeSandbox();
        
        // Clear evaluation results
        foreach (var condition in conditions)
        {
            condition.EvaluationResult = null;
        }
        evaluationResults.Clear();
        combinedResult = false;

        NotificationService.Notify(new NotificationMessage 
        { 
            Severity = NotificationSeverity.Info, 
            Summary = "Session Reset", 
            Detail = "Sandbox session has been reset to initial state", 
            Duration = 3000 
        });
    }

    public void Dispose()
    {
        CurrentGameService.OnChange -= OnGamePackChanged;
    }

    private class ConditionModel
    {
        public string Id { get; set; } = string.Empty;
        public string ConditionText { get; set; } = string.Empty;
        public AdventureGame.Engine.DSL.Parser.DslParseResult? ParseResult { get; set; }
        public bool? EvaluationResult { get; set; }
    }

    private class GameSessionDslContext : DslEvaluationContext
    {
        private readonly GameSession _session;

        public GameElement? Target { get; set; }
        public GameElement? Target1 { get; set; }
        public GameElement? Target2 { get; set; }

        public GameSessionDslContext(GameSession session)
        {
            _session = session ?? throw new ArgumentNullException(nameof(session));
        }

        public override object? GetPlayer() => _session.Player;
        public override object? GetTarget() => Target1 ?? Target;
        public override object? GetTarget2() => Target2;
        public override object? GetCurrentScene() => _session.CurrentScene;
        public override object? GetSession() => _session;
        public override object? GetLog() => _session.History;

        public override object? GetElement(string kind, string? id)
        {
            if (string.IsNullOrWhiteSpace(id) || _session.Pack?.Elements == null)
                return null;

            return _session.Pack.Elements.FirstOrDefault(e => 
                e.Kind.Equals(kind, StringComparison.OrdinalIgnoreCase) && 
                (e.Id.ToString() == id || e.Name.Equals(id, StringComparison.OrdinalIgnoreCase)));
        }

        public override int GetVisitCount(string subjectKind, string sceneName)
        {
            // TODO: Implement visit tracking
            return 0;
        }

        public override int GetDistance(AdventureGame.Engine.DSL.AST.SubjectRef from, AdventureGame.Engine.DSL.AST.SubjectRef to)
        {
            // TODO: Implement distance calculation
            return 0;
        }
    }
}
