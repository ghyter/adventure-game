@page "/tools/conditions"
@using AdventureGame.Engine.Models
@using AdventureGame.Engine.Models.Elements
@using AdventureGame.Engine.Runtime
@using AdventureGame.Engine.Services
@using AdventureGame.Engine.DSL
@using AdventureGame.Engine.DSL.Evaluation
@using AdventureGame.Components.Rules
@using AdventureGame.Components.SessionAudit
@using AdventureGame.Components.Pages.Tools
@using NUlid
@inject AdventureGame.Editor.Services.CurrentGameService CurrentGameService
@inject NotificationService NotificationService
@inject DialogService DialogService

<PageTitle>Condition & Effect Tester</PageTitle>

<RadzenStack Gap="8">
    <RadzenText TextStyle="TextStyle.H5" Style="margin: 0;">🧪 Condition Tester</RadzenText>

    @if (!CurrentGameService.HasCurrent)
    {
        <RadzenAlert AlertStyle="AlertStyle.Warning" Variant="Variant.Flat">
            Please load a GamePack first.
        </RadzenAlert>
    }
    else
    {
        <!-- Compact Control Bar -->
        <RadzenStack Orientation="Orientation.Horizontal" Gap="8" AlignItems="AlignItems.Center" Wrap="FlexWrap.Wrap" Style="padding: 8px; background: var(--rz-base-200); border-radius: 4px;">
            <RadzenDropDown @bind-Value="@conditionType" 
                          Data="@conditionTypes" 
                          Style="min-width: 140px;"
                          Change="@OnConditionTypeChanged" />

            <RadzenDropDown @bind-Value="@selectedPlayerId"
                          Data="@GetAvailablePlayers()"
                          TextProperty="Name"
                          ValueProperty="Id"
                          AllowClear="true"
                          Placeholder="Player..."
                          Style="min-width: 140px;"
                          Change="@OnPlayerChanged" />

            @if (conditionType == "Verb Condition")
            {
                <RadzenDropDown @bind-Value="@selectedTarget1Id" 
                              Data="@availableElements" 
                              TextProperty="Name"
                              ValueProperty="Id"
                              AllowClear="true"
                              Placeholder="Target 1..."
                              Style="min-width: 150px;"
                              Change="@OnTargetChanged" />

                <RadzenDropDown @bind-Value="@selectedTarget2Id" 
                              Data="@availableElements" 
                              TextProperty="Name"
                              ValueProperty="Id"
                              AllowClear="true"
                              Placeholder="Target 2..."
                              Disabled="@(selectedTarget1Id == null)"
                              Style="min-width: 150px;"
                              Change="@OnTargetChanged" />
            }

            <RadzenDropDown @bind-Value="@selectedSceneId"
                          Data="@availableScenes"
                          TextProperty="Name"
                          ValueProperty="Id"
                          AllowClear="true"
                          Placeholder="Current Scene..."
                          Style="min-width: 150px;"
                          Change="@OnSceneChanged" />

            <RadzenButton Icon="add_circle" Text="Add" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" Click="@AddCondition" />
            <RadzenButton Icon="refresh" Text="Reset" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small" Click="@ResetSession" />
            <RadzenButton Icon="help_outline" ButtonStyle="ButtonStyle.Info" Size="ButtonSize.Small" Click="@ShowExamples" />
        </RadzenStack>

        <!-- Conditions List -->
        @if (conditions.Count == 0)
        {
            <RadzenText TextStyle="TextStyle.Body2" Style="opacity: 0.6; padding: 8px;">No conditions. Click "Add" to start testing.</RadzenText>
        }
        else
        {
            <RadzenStack Gap="4">
                @foreach (var condition in conditions)
                {
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="4" AlignItems="AlignItems.Center" Style="padding: 4px; border: 1px solid var(--rz-border-color); border-radius: 4px;">
                        <!-- Result Icon -->
                        @if (condition.EvaluationResult != null)
                        {
                            @if (condition.EvaluationResult.Value)
                            {
                                <RadzenIcon Icon="check_circle" Style="color: var(--rz-success); font-size: 20px;" />
                            }
                            else
                            {
                                <RadzenIcon Icon="cancel" Style="color: var(--rz-danger); font-size: 20px;" />
                            }
                        }
                        else
                        {
                            <RadzenIcon Icon="radio_button_unchecked" Style="opacity: 0.3; font-size: 20px;" />
                        }

                        <!-- Condition Input -->
                        <div style="flex: 1;">
                            <RadzenTextBox @bind-Value="condition.ConditionText" 
                                         Placeholder="when desk state is closed"
                                         Style="width: 100%; font-family: monospace; font-size: 0.9rem;"
                                         Change="@(() => OnConditionTextChanged(condition))" />
                        </div>

                        <!-- Delete Button -->
                        <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" 
                                    Size="ButtonSize.Small" Variant="Variant.Text"
                                    Click="@(() => RemoveCondition(condition))" />
                    </RadzenStack>

                    <!-- Show canonical form if parsed successfully -->
                    @if (condition.ParseResult != null && condition.ParseResult.Success && !string.IsNullOrEmpty(condition.CanonicalForm))
                    {
                        <div style="padding-left: 28px; margin-top: -2px; margin-bottom: 2px;">
                            <RadzenText TextStyle="TextStyle.Caption" Style="color: var(--rz-info); font-family: monospace; opacity: 0.8;">
                                → @condition.CanonicalForm
                            </RadzenText>
                        </div>
                    }

                    <!-- Show C# expression if parsed successfully -->
                    @if (condition.ParseResult != null && condition.ParseResult.Success && condition.ParseResult.Ast != null)
                    {
                        <div style="padding-left: 28px; margin-top: -2px;">
                            <RadzenText TextStyle="TextStyle.Caption" Style="color: var(--rz-secondary); font-family: monospace; opacity: 0.7;">
                                ≡ @GenerateCSharpExpression(condition.ParseResult.Ast)
                            </RadzenText>
                        </div>
                    }

                    @if (condition.ParseResult != null && !condition.ParseResult.Success)
                    {
                        <div style="padding-left: 28px; margin-top: -2px;">
                            @foreach (var error in condition.ParseResult.Errors.Take(1))
                            {
                                <RadzenText TextStyle="TextStyle.Caption" Style="color: var(--rz-danger); font-family: monospace;">
                                    @error.Message
                                </RadzenText>
                            }
                        </div>
                    }
                }
            </RadzenStack>

            @if (evaluationResults.Count > 0)
            {
                <RadzenStack Orientation="Orientation.Horizontal" Gap="8" AlignItems="AlignItems.Center" 
                           Style="@GetResultStyle()" class="result-summary">
                    @if (combinedResult)
                    {
                        <RadzenIcon Icon="check_circle" Style="color: var(--rz-success);" />
                        <RadzenText TextStyle="TextStyle.Subtitle2" Style="margin: 0; color: var(--rz-success);">All conditions pass</RadzenText>
                    }
                    else
                    {
                        <RadzenIcon Icon="cancel" Style="color: var(--rz-danger);" />
                        <RadzenText TextStyle="TextStyle.Subtitle2" Style="margin: 0; color: var(--rz-danger);">
                            @evaluationResults.Count(kvp => kvp.Value)/@evaluationResults.Count pass
                        </RadzenText>
                    }
                </RadzenStack>
            }
        }

        <!-- Session Audit (Note: Edit functionality is disabled in sandbox mode) -->
        <SessionAudit Session="@sandboxSession" OnRequestEdit="@HandleEditRequest" />
    }
</RadzenStack>

@code {
    private GameSession? sandboxSession;
    private List<ConditionModel> conditions = new();
    private Dictionary<string, bool> evaluationResults = new();
    private bool combinedResult = false;
    private bool hasValidConditions => conditions.Any(c => c.ParseResult?.Success == true);

    private IGameSessionFactory sessionFactory = new GameSessionFactory();
    private DslService? dslService;

    // Condition type selection
    private string conditionType = "Verb Condition";
    private string[] conditionTypes = ["Verb Condition", "Trigger Condition"];

    // Target and scene selection
    private object? selectedPlayerId = null;
    private ElementId? selectedTarget1Id = null;
    private ElementId? selectedTarget2Id = null;
    private ElementId? selectedSceneId = null;
    private List<GameElement> availableElements = new();
    private List<Scene> availableScenes = new();

    protected override void OnInitialized()
    {
        if (CurrentGameService.HasCurrent && CurrentGameService.CurrentPack != null)
        {
            InitializeSandbox();
        }

        CurrentGameService.OnChange += OnGamePackChanged;
    }

    private void OnGamePackChanged()
    {
        if (CurrentGameService.HasCurrent && CurrentGameService.CurrentPack != null)
        {
            InitializeSandbox();
        }
        else
        {
            sandboxSession = null;
            dslService = null;
            availableElements.Clear();
            availableScenes.Clear();
        }
        StateHasChanged();
    }

    private void InitializeSandbox()
    {
        if (CurrentGameService.CurrentPack == null) return;

        try
        {
            sandboxSession = sessionFactory.CreateSandboxSession(CurrentGameService.CurrentPack);
            
            // Create DSL service with vocabulary from game pack
            var vocab = DslVocabulary.FromGamePack(CurrentGameService.CurrentPack);
            dslService = new DslService(vocab);

            // Populate available elements and scenes
            availableElements = sandboxSession.Elements.ToList();
            availableScenes = sandboxSession.Elements.OfType<Scene>().ToList();

            // Set default player
            if (sandboxSession.Player != null)
            {
                selectedPlayerId = sandboxSession.Player.Id;
            }

            // Set default scene
            if (selectedSceneId == null && availableScenes.Any())
            {
                selectedSceneId = availableScenes[0].Id;
                sandboxSession.CurrentScene = availableScenes[0];
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage 
            { 
                Severity = NotificationSeverity.Error, 
                Summary = "Init Error", 
                Detail = ex.Message, 
                Duration = 3000 
            });
        }
    }

    private List<GameElement> GetAvailablePlayers()
    {
        if (sandboxSession?.Elements == null) return new();
        return sandboxSession.Elements
            .Where(e => e.Kind == "player")
            .ToList();
    }

    private void OnPlayerChanged()
    {
        if (selectedPlayerId != null && sandboxSession != null)
        {
            sandboxSession.Player = sandboxSession.Elements
                .FirstOrDefault(e => e.Id == (AdventureGame.Engine.Models.ElementId)(dynamic)selectedPlayerId);
        }
        EvaluateAllConditions();
    }

    private void OnConditionTypeChanged()
    {
        if (conditionType == "Trigger Condition")
        {
            selectedTarget1Id = null;
            selectedTarget2Id = null;
        }
        EvaluateAllConditions();
    }

    private void OnTargetChanged()
    {
        if (selectedTarget1Id == null)
        {
            selectedTarget2Id = null;
        }
        EvaluateAllConditions();
    }

    private void OnSceneChanged()
    {
        if (sandboxSession != null && selectedSceneId != null)
        {
            sandboxSession.CurrentScene = availableScenes.FirstOrDefault(s => s.Id == selectedSceneId);
        }
        EvaluateAllConditions();
    }

    private void OnConditionTextChanged(ConditionModel condition)
    {
        // Parse the condition
        if (string.IsNullOrWhiteSpace(condition.ConditionText))
        {
            condition.ParseResult = null;
            condition.EvaluationResult = null;
            condition.CanonicalForm = null;
        }
        else if (dslService != null)
        {
            // Get the canonical form first
            var vocab = DslVocabulary.FromGamePack(CurrentGameService.CurrentPack!);
            var canonicalizer = new AdventureGame.Engine.DSL.DslCanonicalizer();
            condition.CanonicalForm = canonicalizer.Canonicalize(condition.ConditionText, vocab);
            
            // Parse using the DSL service
            condition.ParseResult = dslService.ParseAndValidate(condition.ConditionText);
        }

        // Auto-evaluate all conditions
        EvaluateAllConditions();
    }

    private GameElement? FindElement(ElementId? elementId)
    {
        if (elementId == null || sandboxSession == null) return null;
        return sandboxSession.Elements.FirstOrDefault(e => e.Id == elementId);
    }

    private async Task ShowExamples()
    {
        await DialogService.OpenAsync<ConditionExamplesDialog>(
            "Condition Examples",
            new Dictionary<string, object>(),
            new DialogOptions { Width = "500px", Height = "400px" });
    }

    private void AddCondition()
    {
        conditions.Add(new ConditionModel 
        { 
            Id = Guid.NewGuid().ToString(),
            ConditionText = ""
        });
    }

    private void RemoveCondition(ConditionModel condition)
    {
        conditions.Remove(condition);
        evaluationResults.Remove(condition.Id);
        EvaluateAllConditions();
    }

    private void EvaluateAllConditions()
    {
        if (sandboxSession == null || dslService == null)
            return;

        evaluationResults.Clear();
        var allPassed = true;

        foreach (var condition in conditions.Where(c => c.ParseResult?.Success == true))
        {
            try
            {
                GameSessionDslContext ctx;

                if (conditionType == "Verb Condition")
                {
                    var target1 = FindElement(selectedTarget1Id);
                    var target2 = FindElement(selectedTarget2Id);

                    ctx = new GameSessionDslContext(sandboxSession)
                    {
                        Target = target1,
                        Target1 = target1,
                        Target2 = target2
                    };
                }
                else
                {
                    ctx = new GameSessionDslContext(sandboxSession)
                    {
                        Target = null,
                        Target1 = null,
                        Target2 = null
                    };
                }

                var result = DslService.Evaluate(condition.ParseResult!.Ast!, ctx);
                
                condition.EvaluationResult = result;
                evaluationResults[condition.Id] = result;
                
                if (!result)
                    allPassed = false;
            }
            catch (Exception)
            {
                condition.EvaluationResult = false;
                evaluationResults[condition.Id] = false;
                allPassed = false;
            }
        }

        combinedResult = allPassed && evaluationResults.Count > 0;
        StateHasChanged();
    }

    private void ResetSession()
    {
        InitializeSandbox();
        
        foreach (var condition in conditions)
        {
            condition.EvaluationResult = null;
        }
        evaluationResults.Clear();
        combinedResult = false;

        EvaluateAllConditions();
    }

    private async Task HandleEditRequest(GameElement element)
    {
        // Find the corresponding element in the actual pack (not the sandbox)
        var actualElement = CurrentGameService.CurrentPack?.Elements.FirstOrDefault(e => e.Id == element.Id);
        
        if (actualElement == null)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = "Element Not Found",
                Detail = "This element exists only in the sandbox and cannot be edited in the actual game pack.",
                Duration = 3000
            });
            return;
        }

        // Open the editor for the actual element
        var parameters = new Dictionary<string, object?> { ["Element"] = actualElement };
        var result = await DialogService.OpenSideAsync<GameElementEditor>(
            title: $"Edit {actualElement.Name}",
            parameters: parameters,
            options: new SideDialogOptions() { Width = "70%" }
        );

        // If changes were made, reinitialize the sandbox to reflect them
        if (result != null)
        {
            InitializeSandbox();
            EvaluateAllConditions();
        }
    }

    public void Dispose()
    {
        CurrentGameService.OnChange -= OnGamePackChanged;
    }

    private string GetResultStyle()
    {
        var bgColor = combinedResult ? "var(--rz-success-lighter)" : "var(--rz-danger-lighter)";
        return $"padding: 8px; background: {bgColor}; border-radius: 4px; margin-top: 4px;";
    }

    /// <summary>
    /// Generates a C#-like expression from the condition AST for display purposes.
    /// </summary>
    private string GenerateCSharpExpression(AdventureGame.Engine.DSL.AST.ConditionNode ast)
    {
        return ast switch
        {
            AdventureGame.Engine.DSL.AST.AndNode and => 
                $"({GenerateCSharpExpression(and.Left)} && {GenerateCSharpExpression(and.Right)})",
            
            AdventureGame.Engine.DSL.AST.OrNode or => 
                $"({GenerateCSharpExpression(or.Left)} || {GenerateCSharpExpression(or.Right)})",
            
            AdventureGame.Engine.DSL.AST.NotNode not => 
                $"!({GenerateCSharpExpression(not.Inner)})",
            
            AdventureGame.Engine.DSL.AST.RelationNode rel => 
                GenerateRelationExpression(rel),
            
            AdventureGame.Engine.DSL.AST.CountRelationNode count => 
                $"GetVisitCount(\"{count.Subject.Kind}\", \"{count.SceneName}\") {MapComparison(count.Comparison)} {count.Value}",
            
            AdventureGame.Engine.DSL.AST.DistanceRelationNode dist => 
                $"GetDistance({dist.SubjectA.Kind}, {dist.SubjectB.Kind}) {MapComparison(dist.Comparison)} {dist.Value}",
            
            _ => "unknown"
        };
    }

    private string GenerateRelationExpression(AdventureGame.Engine.DSL.AST.RelationNode rel)
    {
        // Handle "has" relation specially
        if (rel.Relation.Equals("has", StringComparison.OrdinalIgnoreCase))
        {
            var subject = FormatSubject(rel.Subject);
            var objectValue = rel.Object.Value ?? "null";
            return $"{subject}.Contains(\"{objectValue}\")";
        }

        var subjectExpr = FormatSubjectWithProperty(rel.Subject, rel.AttributeName, rel.PropertyName);
        var objectExpr = FormatObject(rel.Object);
        var comparison = MapComparison(rel.Relation);

        return $"{subjectExpr} {comparison} {objectExpr}";
    }

    private string FormatSubject(AdventureGame.Engine.DSL.AST.SubjectRef subject)
    {
        return subject.Kind.ToLower() switch
        {
            "player" => "player",
            "target" => "target",
            "target2" => "target2",
            "currentscene" => "currentScene",
            "location" => "currentScene",
            "session" => "session",
            "log" => "log",
            "item" => $"GetElement(\"item\", \"{subject.Id}\")",
            "npc" => $"GetElement(\"npc\", \"{subject.Id}\")",
            "scene" => $"GetElement(\"scene\", \"{subject.Id}\")",
            "exit" => $"GetElement(\"exit\", \"{subject.Id}\")",
            _ => subject.Kind
        };
    }

    private string FormatSubjectWithProperty(
        AdventureGame.Engine.DSL.AST.SubjectRef subject, 
        string? attributeName, 
        string? propertyName)
    {
        var baseSubject = FormatSubject(subject);

        if (!string.IsNullOrEmpty(attributeName))
        {
            return $"{baseSubject}.Attributes[\"{attributeName}\"]";
        }

        if (!string.IsNullOrEmpty(propertyName))
        {
            if (propertyName.Equals("state", StringComparison.OrdinalIgnoreCase))
            {
                // Show that we check CurrentState first, then fall back to DefaultState
                return $"{baseSubject}.Properties[\"CurrentState\"] ?? {baseSubject}.DefaultState";
            }
            return $"{baseSubject}.{propertyName}";
        }

        return baseSubject;
    }

    private string FormatObject(AdventureGame.Engine.DSL.AST.ObjectRef obj)
    {
        if (obj.BoolValue != null)
        {
            return obj.BoolValue.Value ? "true" : "false";
        }

        if (obj.NumericValue != null)
        {
            return obj.NumericValue.Value.ToString();
        }

        if (obj.Kind == "element")
        {
            return $"\"{obj.Value}\"";
        }

        return $"\"{obj.Value}\"";
    }

    private string MapComparison(string relation)
    {
        return relation.ToLower() switch
        {
            "is" => "==",
            "is_not" => "!=",
            "is_less_than" => "<",
            "is_greater_than" => ">",
            "is_equal_to" => "==",
            "is_not_equal_to" => "!=",
            "is_in" => "∈",
            "is_empty" => "== null || .Count == 0",
            _ => relation
        };
    }

    private class ConditionModel
    {
        public string Id { get; set; } = string.Empty;
        public string ConditionText { get; set; } = string.Empty;
        public string? CanonicalForm { get; set; }
        public AdventureGame.Engine.DSL.Parser.DslParseResult? ParseResult { get; set; }
        public bool? EvaluationResult { get; set; }
    }

    private class GameSessionDslContext : DslEvaluationContext
    {
        private readonly GameSession _session;

        public GameElement? Target { get; set; }
        public GameElement? Target1 { get; set; }
        public GameElement? Target2 { get; set; }
        public GameSession Session => _session;

        public GameSessionDslContext(GameSession session)
        {
            _session = session ?? throw new ArgumentNullException(nameof(session));
        }

        public override object? GetPlayer() => _session.Player;
        public override object? GetTarget() => Target1 ?? Target;
        public override object? GetTarget2() => Target2;
        public override object? GetCurrentScene() => _session.CurrentScene;
        public override object? GetSession() => _session;
        public override object? GetLog() => _session.History;

        public override object? GetElement(string kind, string? id)
        {
            if (string.IsNullOrWhiteSpace(id) || _session.Elements == null)
                return null;

            // Use _session.Elements (runtime state) instead of _session.Pack.Elements (default state)
            return _session.Elements.FirstOrDefault(e => 
                e.Kind.Equals(kind, StringComparison.OrdinalIgnoreCase) && 
                (e.Id.ToString() == id || e.Name.Equals(id, StringComparison.OrdinalIgnoreCase)));
        }

        public override int GetVisitCount(string subjectKind, string sceneName)
        {
            return 0;
        }

        public override int GetDistance(AdventureGame.Engine.DSL.AST.SubjectRef from, AdventureGame.Engine.DSL.AST.SubjectRef to)
        {
            return 0;
        }
    }
}
