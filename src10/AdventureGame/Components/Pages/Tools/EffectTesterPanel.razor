@using AdventureGame.Engine.Models
@using AdventureGame.Engine.Models.Elements
@using AdventureGame.Engine.Runtime
@using AdventureGame.Engine.Verbs
@inject NotificationService NotificationService

<RadzenStack Gap="8">
    <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">Effect Tester</RadzenText>

    @* Effect Definition *@
    <RadzenCard>
        <RadzenStack Gap="8">
            <RadzenFormField Text="Min Roll (0 = auto-success)" Variant="Variant.Outlined">
                <RadzenNumeric @bind-Value="@effectMin" 
                             TValue="int"
                             Min="0" Max="20"
                             Style="width: 100%;" />
            </RadzenFormField>

            <RadzenFormField Text="Max Roll" Variant="Variant.Outlined">
                <RadzenNumeric @bind-Value="@effectMax" 
                             TValue="int"
                             Min="0" Max="20"
                             Style="width: 100%;" />
            </RadzenFormField>

            <RadzenFormField Text="Success Message" Variant="Variant.Outlined">
                <RadzenTextArea @bind-Value="@effectSuccessText" 
                              Rows="2"
                              Style="width: 100%;" />
            </RadzenFormField>

            <RadzenFormField Text="Failure Message" Variant="Variant.Outlined">
                <RadzenTextArea @bind-Value="@effectFailureText" 
                              Rows="2"
                              Style="width: 100%;" />
            </RadzenFormField>

            <RadzenFormField Text="Action" Variant="Variant.Outlined">
                <RadzenTextBox @bind-Value="@effectAction" 
                             Style="width: 100%;"
                             Placeholder="e.g., ChangeState:door:open" />
            </RadzenFormField>
        </RadzenStack>
    </RadzenCard>

    @* Target Selection *@
    <RadzenCard>
        <RadzenStack Gap="8">
            <RadzenText TextStyle="TextStyle.Subtitle2" Style="margin: 0;">Effect Targets</RadzenText>

            <RadzenFormField Text="Target 1" Variant="Variant.Outlined">
                <RadzenDropDown @bind-Value="@selectedTarget1Id"
                              Data="@GetAvailableElements()"
                              TextProperty="Name"
                              ValueProperty="Id"
                              AllowClear="true"
                              Placeholder="Select target..."
                              Style="width: 100%;"
                              Change="@OnTargetChanged" />
            </RadzenFormField>

            <RadzenFormField Text="Target 2" Variant="Variant.Outlined">
                <RadzenDropDown @bind-Value="@selectedTarget2Id"
                              Data="@GetAvailableElements()"
                              TextProperty="Name"
                              ValueProperty="Id"
                              AllowClear="true"
                              Placeholder="Select target..."
                              Style="width: 100%;"
                              Change="@OnTargetChanged" />
            </RadzenFormField>
        </RadzenStack>
    </RadzenCard>

    @* Actions *@
    <RadzenStack Orientation="Orientation.Horizontal" Gap="8">
        <RadzenButton Icon="play_arrow" Text="Execute Effect" 
                    ButtonStyle="ButtonStyle.Primary"
                    Click="@ExecuteEffect" />
        <RadzenButton Icon="refresh" Text="Clear" 
                    ButtonStyle="ButtonStyle.Light"
                    Click="@ClearEffect" />
    </RadzenStack>

    @* Results *@
    @if (lastResult != null)
    {
        <RadzenAlert AlertStyle="@(lastResult.Success ? AlertStyle.Success : AlertStyle.Warning)" 
                   Variant="Variant.Flat">
            <RadzenStack Gap="4">
                <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">
                    @(lastResult.Success ? "✓ Success" : "✗ Failed")
                </RadzenText>

                <RadzenText TextStyle="TextStyle.Body2">
                    <strong>Message:</strong> @(lastResult.Success ? lastResult.SuccessText : lastResult.FailureText)
                </RadzenText>

                @if (!string.IsNullOrWhiteSpace(lastResult.RollResult))
                {
                    <RadzenText TextStyle="TextStyle.Body2">
                        <strong>Roll:</strong> @lastResult.RollResult
                    </RadzenText>
                }

                @if (!string.IsNullOrWhiteSpace(lastResult.ActionApplied))
                {
                    <RadzenText TextStyle="TextStyle.Body2">
                        <strong>Action:</strong> @lastResult.ActionApplied
                    </RadzenText>
                }
            </RadzenStack>
        </RadzenAlert>
    }
</RadzenStack>

@code {
    [Parameter, EditorRequired]
    public GameSession Session { get; set; } = null!;

    [Parameter]
    public EventCallback<List<ElementId>> OnElementsTargeted { get; set; }

    private int effectMin = 0;
    private int effectMax = 0;
    private string effectSuccessText = "";
    private string effectFailureText = "";
    private string effectAction = "";

    private ElementId? selectedTarget1Id = null;
    private ElementId? selectedTarget2Id = null;

    private EffectTestResult? lastResult = null;

    private List<GameElement> GetAvailableElements()
    {
        return Session?.Elements?.ToList() ?? new List<GameElement>();
    }

    private void OnTargetChanged()
    {
        // Notify parent about targeted elements
        var targetedIds = new List<ElementId>();
        if (selectedTarget1Id.HasValue) targetedIds.Add(selectedTarget1Id.Value);
        if (selectedTarget2Id.HasValue) targetedIds.Add(selectedTarget2Id.Value);
        
        if (OnElementsTargeted.HasDelegate)
        {
            OnElementsTargeted.InvokeAsync(targetedIds);
        }
    }

    private void ExecuteEffect()
    {
        if (Session == null)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = "No Session",
                Detail = "Initialize a sandbox session first",
                Duration = 3000
            });
            return;
        }

        try
        {
            bool success;
            string rollResult = "";

            if (effectMin == 0 && effectMax == 0)
            {
                success = true;
                rollResult = "Auto-success (no roll)";
            }
            else
            {
                var random = new Random();
                int roll = random.Next(1, 21);
                rollResult = $"Rolled {roll} (range {effectMin}-{effectMax})";

                if (roll == 1)
                {
                    success = false;
                }
                else if (roll == 20)
                {
                    success = true;
                }
                else
                {
                    success = roll >= effectMin && roll <= effectMax;
                }
            }

            lastResult = new EffectTestResult
            {
                Success = success,
                SuccessText = effectSuccessText,
                FailureText = effectFailureText,
                RollResult = rollResult,
                ActionApplied = effectAction
            };

            NotificationService.Notify(new NotificationMessage
            {
                Severity = success ? NotificationSeverity.Success : NotificationSeverity.Warning,
                Summary = success ? "Effect Succeeded" : "Effect Failed",
                Detail = success ? effectSuccessText : effectFailureText,
                Duration = 3000
            });
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Execution Error",
                Detail = ex.Message,
                Duration = 3000
            });
        }
    }

    private void ClearEffect()
    {
        lastResult = null;
        effectMin = 0;
        effectMax = 0;
        effectSuccessText = "";
        effectFailureText = "";
        effectAction = "";
        selectedTarget1Id = null;
        selectedTarget2Id = null;
        
        if (OnElementsTargeted.HasDelegate)
        {
            OnElementsTargeted.InvokeAsync(new List<ElementId>());
        }
        
        StateHasChanged();
    }

    private class EffectTestResult
    {
        public bool Success { get; set; }
        public string SuccessText { get; set; } = "";
        public string FailureText { get; set; } = "";
        public string RollResult { get; set; } = "";
        public string ActionApplied { get; set; } = "";
    }
}
