@page "/gamepack/verbs/edit"
@using AdventureGame.Engine.Verbs
@using AdventureGame.Engine.Filters
@using AdventureGame.Components.Shared
@inject AdventureGame.Editor.Services.CurrentGameService CurrentGameService
@inject DialogService DialogService

<RadzenStack Gap="12" Style="padding: 16px;">
    <!-- Basic Info Section -->
    <RadzenCard Style="padding: 16px;">
        <RadzenStack Gap="12">
            <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">Basic Information</RadzenText>
            
            <RadzenFormField Text="Name" Variant="Variant.Outlined">
                <RadzenTextBox @bind-Value="@Verb.Name" 
                             Style="width: 100%;" 
                             Placeholder="e.g., take, use, examine" />
            </RadzenFormField>

            <RadzenFormField Text="Aliases" Variant="Variant.Outlined">
                <ChildContent>
                    <AdventureGame.Engine.Components.StringHashSetEditor @bind-Value="@Verb.Aliases" />
                </ChildContent>
                <Helper>
                    <RadzenText TextStyle="TextStyle.Caption" Style="opacity: 0.7;">
                        Alternative names (e.g., "grab", "pick up" for "take")
                    </RadzenText>
                </Helper>
            </RadzenFormField>

            <RadzenFormField Text="Tags" Variant="Variant.Outlined">
                <ChildContent>
                    <AdventureGame.Engine.Components.StringHashSetEditor @bind-Value="@Verb.Tags" />
                </ChildContent>
                <Helper>
                    <RadzenText TextStyle="TextStyle.Caption" Style="opacity: 0.7;">
                        Categories for organizing verbs (e.g., "movement", "interaction")
                    </RadzenText>
                </Helper>
            </RadzenFormField>

            <RadzenFormField Text="Target Count" Variant="Variant.Outlined">
                <ChildContent>
                    <RadzenDropDown @bind-Value="@Verb.TargetCount"
                                  Data="@targetCountOptions"
                                  Style="width: 100%;"
                                  Change="@OnTargetCountChanged" />
                </ChildContent>
                <Helper>
                    <RadzenText TextStyle="TextStyle.Caption" Style="opacity: 0.7;">
                        How many targets this verb requires (0=no target, 1=one target, 2=two targets)
                    </RadzenText>
                </Helper>
            </RadzenFormField>
        </RadzenStack>
    </RadzenCard>

    <!-- Target Filters Section -->
    @if (Verb.TargetCount > 0)
    {
        <RadzenCard Style="padding: 16px;">
            <RadzenStack Gap="12">
                <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">Target Filters</RadzenText>
                <RadzenText TextStyle="TextStyle.Caption" Style="opacity: 0.7; margin-top: -8px;">
                    Define what game elements this verb can target. More specific filters score higher.
                </RadzenText>

                <RadzenFieldset Text="Target 1" Style="margin-top: 8px;">
                    <GameElementFilterControl Filter="@Verb.Target1" 
                                            AvailableElements="@CurrentGameService.CurrentPack?.Elements"
                                            OnChange="@StateHasChanged" />
                </RadzenFieldset>

                @if (Verb.TargetCount > 1)
                {
                    <RadzenFieldset Text="Target 2">
                        <GameElementFilterControl Filter="@Verb.Target2" 
                                                AvailableElements="@CurrentGameService.CurrentPack?.Elements"
                                                OnChange="@StateHasChanged" />
                    </RadzenFieldset>
                }
            </RadzenStack>
        </RadzenCard>
    }
    else
    {
        <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat">
            This verb does not require any targets.
        </RadzenAlert>
    }

    <!-- Conditions Section -->
    <RadzenCard Style="padding: 16px;">
        <RadzenStack Gap="12">
            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                <RadzenStack Gap="4">
                    <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">Conditions</RadzenText>
                    <RadzenText TextStyle="TextStyle.Caption" Style="opacity: 0.7;">
                        All conditions must be met for the verb to execute
                    </RadzenText>
                </RadzenStack>
                <RadzenButton Icon="add" Text="Add Condition" 
                            Size="ButtonSize.Small"
                            ButtonStyle="ButtonStyle.Success"
                            Click="@AddCondition" />
            </RadzenStack>

            @if (Verb.ConditionTexts.Count == 0)
            {
                <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" Style="margin: 8px 0;">
                    No conditions defined. This verb will always be available.
                </RadzenAlert>
            }
            else
            {
                <RadzenStack Gap="6">
                    @for (int i = 0; i < Verb.ConditionTexts.Count; i++)
                    {
                        var index = i;
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="4" AlignItems="AlignItems.Center">
                            <RadzenIcon Icon="check_circle" Style="color: var(--rz-success); font-size: 18px;" />
                            <RadzenTextBox Value="@Verb.ConditionTexts[index]"
                                         ValueChanged="@((string newValue) => Verb.ConditionTexts[index] = newValue)"
                                         Style="flex: 1;"
                                         Placeholder="e.g., when player has key" />
                            <RadzenButton Icon="delete" 
                                        ButtonStyle="ButtonStyle.Danger" 
                                        Variant="Variant.Text"
                                        Size="ButtonSize.Small"
                                        Click="@(() => RemoveConditionAt(index))" />
                        </RadzenStack>
                    }
                </RadzenStack>
            }
        </RadzenStack>
    </RadzenCard>

    <!-- Effects Section -->
    <RadzenCard Style="padding: 16px;">
        <RadzenStack Gap="12">
            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                <RadzenStack Gap="4">
                    <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">Effects</RadzenText>
                    <RadzenText TextStyle="TextStyle.Caption" Style="opacity: 0.7;">
                        Define what happens when this verb executes
                    </RadzenText>
                </RadzenStack>
                <RadzenButton Icon="add" Text="Add Effect" 
                            Size="ButtonSize.Small"
                            ButtonStyle="ButtonStyle.Success"
                            Click="@AddEffect" />
            </RadzenStack>

            @if (Verb.Effects.Count == 0)
            {
                <RadzenAlert AlertStyle="AlertStyle.Warning" Variant="Variant.Flat" Style="margin: 8px 0;">
                    No effects defined. This verb won't do anything when executed.
                </RadzenAlert>
            }
            else
            {
                <RadzenStack Gap="8">
                    @for (int i = 0; i < Verb.Effects.Count; i++)
                    {
                        var index = i;
                        var effect = Verb.Effects[index];
                        <RadzenCard Style="padding: 12px; background: var(--rz-base-200);">
                            <RadzenStack Gap="10">
                                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                                    <RadzenBadge Text="@($"Effect {index + 1}")" BadgeStyle="BadgeStyle.Secondary" />
                                    <RadzenButton Icon="delete" 
                                                ButtonStyle="ButtonStyle.Danger" 
                                                Variant="Variant.Text"
                                                Size="ButtonSize.Small"
                                                Click="@(() => RemoveEffect(effect))" />
                                </RadzenStack>

                                <RadzenRow>
                                    <RadzenColumn Size="6">
                                        <RadzenFormField Text="Min Roll" Variant="Variant.Outlined">
                                            <ChildContent>
                                                <RadzenNumeric @bind-Value="@effect.Min" 
                                                             TValue="int"
                                                             Min="0" Max="20"
                                                             Style="width: 100%;" />
                                            </ChildContent>
                                            <Helper>
                                                <RadzenText TextStyle="TextStyle.Caption" Style="opacity: 0.7;">
                                                    0 = always succeeds
                                                </RadzenText>
                                            </Helper>
                                        </RadzenFormField>
                                    </RadzenColumn>
                                    <RadzenColumn Size="6">
                                        <RadzenFormField Text="Max Roll" Variant="Variant.Outlined">
                                            <ChildContent>
                                                <RadzenNumeric @bind-Value="@effect.Max" 
                                                             TValue="int"
                                                             Min="0" Max="20"
                                                             Style="width: 100%;" />
                                            </ChildContent>
                                            <Helper>
                                                <RadzenText TextStyle="TextStyle.Caption" Style="opacity: 0.7;">
                                                    0/0 = no roll needed
                                                </RadzenText>
                                            </Helper>
                                        </RadzenFormField>
                                    </RadzenColumn>
                                </RadzenRow>

                                <RadzenFormField Text="Success Message" Variant="Variant.Outlined">
                                    <RadzenTextArea @bind-Value="@effect.SuccessText" 
                                                  Rows="2"
                                                  Style="width: 100%;"
                                                  Placeholder="e.g., You successfully take the {target}." />
                                </RadzenFormField>

                                <RadzenFormField Text="Failure Message" Variant="Variant.Outlined">
                                    <RadzenTextArea @bind-Value="@effect.FailureText" 
                                                  Rows="2"
                                                  Style="width: 100%;"
                                                  Placeholder="e.g., You fail to take the {target}." />
                                </RadzenFormField>

                                <RadzenFormField Text="Action" Variant="Variant.Outlined">
                                    <ChildContent>
                                        <RadzenTextBox @bind-Value="@effect.Action" 
                                                     Style="width: 100%;"
                                                     Placeholder="e.g., MoveTo:target:player, ChangeState:door:open" />
                                    </ChildContent>
                                    <Helper>
                                        <RadzenText TextStyle="TextStyle.Caption" Style="opacity: 0.7;">
                                            Format: ActionType:target:value
                                        </RadzenText>
                                    </Helper>
                                </RadzenFormField>
                            </RadzenStack>
                        </RadzenCard>
                    }
                </RadzenStack>
            }
        </RadzenStack>
    </RadzenCard>

    <!-- Action Buttons -->
    <RadzenStack Orientation="Orientation.Horizontal" Gap="8" JustifyContent="JustifyContent.End" Style="margin-top: 8px;">
        <RadzenButton Text="Cancel" 
                    ButtonStyle="ButtonStyle.Light" 
                    Click="@Cancel" />
        <RadzenButton Text="Save" 
                    Icon="save"
                    ButtonStyle="ButtonStyle.Primary" 
                    Click="@Save" />
    </RadzenStack>
</RadzenStack>

@code {
    [Parameter]
    public Engine.Verbs.Verb Verb { get; set; } = new();

    private int[] targetCountOptions = { 0, 1, 2 };

    private void OnTargetCountChanged()
    {
        // Update target filter modes based on target count
        if (Verb.TargetCount == 0)
        {
            Verb.Target1.Mode = GameElementFilterMode.None;
            Verb.Target2.Mode = GameElementFilterMode.None;
        }
        else if (Verb.TargetCount == 1)
        {
            // Keep Target1 as is, but set Target2 to None
            Verb.Target2.Mode = GameElementFilterMode.None;
        }
        // If TargetCount == 2, both can be configured

        StateHasChanged();
    }

    private void AddCondition()
    {
        Verb.ConditionTexts.Add("");
        StateHasChanged();
    }

    private void RemoveConditionAt(int index)
    {
        if (index >= 0 && index < Verb.ConditionTexts.Count)
        {
            Verb.ConditionTexts.RemoveAt(index);
            StateHasChanged();
        }
    }

    private void AddEffect()
    {
        Verb.Effects.Add(new VerbEffect());
        StateHasChanged();
    }

    private void RemoveEffect(VerbEffect effect)
    {
        Verb.Effects.Remove(effect);
        StateHasChanged();
    }

    private void Cancel()
    {
        DialogService.CloseSide(null);
    }

    private void Save()
    {
        CurrentGameService.MarkDirty();
        DialogService.CloseSide(Verb);
    }
}
