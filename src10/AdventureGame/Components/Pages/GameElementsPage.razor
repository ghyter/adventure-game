@page "/gamepack/elements"
@using AdventureGame.Components.Editors
@using AdventureGame.Engine.Models
@using AdventureGame.Engine.Models.Elements
@using AdventureGame.Editor.Services

@implements IDisposable
@inject AdventureGame.Editor.Services.CurrentGameService CurrentGameService
@inject DialogService DialogService
@inject NotificationService NotificationService

<RadzenText TextStyle="TextStyle.H3">Elements</RadzenText>

@if (!CurrentGameService.HasCurrent)
{
    <RadzenText>No GamePack selected. Please select a pack from the sidebar.</RadzenText>
}
else
{
    <RadzenStack Orientation="Orientation.Horizontal" Gap="8" AlignItems="AlignItems.Center" Wrap="FlexWrap.Wrap" Style="margin-bottom: 16px;">
        <RadzenDropDown Data="@dropdownItems" TextProperty="Name" ValueProperty="Kind" Style="width:220px" @bind-Value="selectedKindNullable" />
        <RadzenButton Icon="add_circle" ButtonStyle="ButtonStyle.Primary" Text="@AddButtonLabel" Click="@(async args => await AddElement(selectedKindNullable ?? ElementKind.Item))" Disabled="@(selectedKindNullable == null)" />
        
        <RadzenStack Orientation="Orientation.Horizontal" Gap="8" AlignItems="AlignItems.Center" Style="margin-left: auto;">
            <RadzenTextBox @bind-Value="searchText" Placeholder="Search..." Style="width: 250px;" />
            
            <RadzenDropDown Data="@sortOptions" 
                          TextProperty="Text" 
                          ValueProperty="Value" 
                          @bind-Value="selectedSort"
                          Style="width: 180px;"
                          Change="@OnSortChanged" />
            
            <RadzenSelectBar @bind-Value="@viewMode" Style="width: 120px;">
                <Items>
                    <RadzenSelectBarItem Text="Tiles" Value="ViewMode.Tiles" Icon="grid_view" />
                    <RadzenSelectBarItem Text="Grid" Value="ViewMode.Grid" Icon="view_list" />
                </Items>
            </RadzenSelectBar>
        </RadzenStack>
    </RadzenStack>

    @if (viewMode == ViewMode.Tiles)
    {
        <RadzenRow Gap="16px">
            @foreach (var elem in GetSortedElements())
            {
                <RadzenColumn Size="12" SizeMD="6" SizeLG="4" SizeXL="3">
                    <RadzenCard Style="@($"cursor: pointer; height: 100%; background-color: {ElementTypeStyles.GetBackgroundColor(elem.Kind)};")" @onclick="@(() => EditElement(elem))">
                        <RadzenStack Gap="8">
                            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                                <RadzenBadge Text="@elem.Kind.ToString()" BadgeStyle="@ElementTypeStyles.GetBadgeStyle(elem.Kind)" />
                                <RadzenStack Orientation="Orientation.Horizontal" Gap="4" @onclick:stopPropagation="true">
                                    <RadzenButton Icon="content_copy" Size="ButtonSize.ExtraSmall" ButtonStyle="ButtonStyle.Light" Click="@(async args => await CloneElement(elem))" title="Clone" />
                                    <RadzenButton Icon="delete" Size="ButtonSize.ExtraSmall" ButtonStyle="ButtonStyle.Danger" Click="@(args => ConfirmDelete(elem))" Disabled="@(!CanDeleteElement(elem))" title="Delete" />
                                </RadzenStack>
                            </RadzenStack>
                            
                            <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">@elem.Name</RadzenText>
                            
                            <RadzenStack Orientation="Orientation.Horizontal" Gap="4" AlignItems="AlignItems.Center">
                                <RadzenIcon Icon="location_on" Style="font-size: 1rem; opacity: 0.7;" />
                                <RadzenText TextStyle="TextStyle.Caption" Style="opacity: 0.7;">@GetLocationText(elem)</RadzenText>
                            </RadzenStack>
                            
                            @if (elem.Aliases.Any())
                            {
                                <RadzenStack Gap="4">
                                    <RadzenText TextStyle="TextStyle.Caption" Style="font-weight: 600; opacity: 0.8;">Aliases:</RadzenText>
                                    <RadzenStack Orientation="Orientation.Horizontal" Gap="4" Wrap="FlexWrap.Wrap">
                                        @foreach (var alias in elem.Aliases.Take(3))
                                        {
                                            <RadzenBadge Text="@alias" BadgeStyle="BadgeStyle.Info" Variant="Variant.Outlined" />
                                        }
                                        @if (elem.Aliases.Count > 3)
                                        {
                                            <RadzenBadge Text="@($"+{elem.Aliases.Count - 3}")" BadgeStyle="BadgeStyle.Light" />
                                        }
                                    </RadzenStack>
                                </RadzenStack>
                            }
                            
                            @if (elem.Tags.Any())
                            {
                                <RadzenStack Gap="4">
                                    <RadzenText TextStyle="TextStyle.Caption" Style="font-weight: 600; opacity: 0.8;">Tags:</RadzenText>
                                    <RadzenStack Orientation="Orientation.Horizontal" Gap="4" Wrap="FlexWrap.Wrap">
                                        @foreach (var tag in elem.Tags.Take(3))
                                        {
                                            <RadzenBadge Text="@tag" BadgeStyle="BadgeStyle.Success" Variant="Variant.Outlined" />
                                        }
                                        @if (elem.Tags.Count > 3)
                                        {
                                            <RadzenBadge Text="@($"+{elem.Tags.Count - 3}")" BadgeStyle="BadgeStyle.Light" />
                                        }
                                    </RadzenStack>
                                </RadzenStack>
                            }
                        </RadzenStack>
                    </RadzenCard>
                </RadzenColumn>
            }
        </RadzenRow>
    }
    else
    {
        <RadzenDataGrid Data="@GetSortedElements()" TItem="GameElement" 
                        AllowPaging="true" PageSize="20" 
                        AllowSorting="false" AllowFiltering="true" 
                        FilterMode="FilterMode.Simple">
            <Columns>
                <RadzenDataGridColumn TItem="GameElement" Property="Name" Title="Name" Filterable="true">
                    <Template Context="elem">
                        <RadzenText TextStyle="TextStyle.Subtitle2" Style="margin: 0;">@elem.Name</RadzenText>
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="GameElement" Property="Kind" Title="Kind" Width="100px" Filterable="true">
                    <Template Context="elem">
                        <RadzenBadge Text="@elem.Kind.ToString()" BadgeStyle="@ElementTypeStyles.GetBadgeStyle(elem.Kind)" />
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="GameElement" Title="Location" Width="200px">
                    <Template Context="elem">
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="4" AlignItems="AlignItems.Center">
                            <RadzenIcon Icon="location_on" Style="font-size: 1rem; opacity: 0.7;" />
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">@GetLocationText(elem)</RadzenText>
                        </RadzenStack>
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="GameElement" Title="Aliases" Width="200px">
                    <Template Context="elem">
                        @if (elem.Aliases.Any())
                        {
                            <RadzenStack Orientation="Orientation.Horizontal" Gap="4" Wrap="FlexWrap.Wrap">
                                @foreach (var alias in elem.Aliases.Take(3))
                                {
                                    <RadzenBadge Text="@alias" BadgeStyle="BadgeStyle.Info" Variant="Variant.Outlined" />
                                }
                                @if (elem.Aliases.Count > 3)
                                {
                                    <RadzenBadge Text="@($"+{elem.Aliases.Count - 3}")" BadgeStyle="BadgeStyle.Light" />
                                }
                            </RadzenStack>
                        }
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="GameElement" Title="Tags" Width="200px">
                    <Template Context="elem">
                        @if (elem.Tags.Any())
                        {
                            <RadzenStack Orientation="Orientation.Horizontal" Gap="4" Wrap="FlexWrap.Wrap">
                                @foreach (var tag in elem.Tags.Take(3))
                                {
                                    <RadzenBadge Text="@tag" BadgeStyle="BadgeStyle.Success" Variant="Variant.Outlined" />
                                }
                                @if (elem.Tags.Count > 3)
                                {
                                    <RadzenBadge Text="@($"+{elem.Tags.Count - 3}")" BadgeStyle="BadgeStyle.Light" />
                                }
                            </RadzenStack>
                        }
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="GameElement" Title="Actions" Width="150px" Filterable="false">
                    <Template Context="elem">
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="4">
                            <RadzenButton Icon="edit" Size="ButtonSize.Small" Click="@(args => EditElement(elem))" title="Edit" />
                            <RadzenButton Icon="content_copy" Size="ButtonSize.Small" Click="@(async args => await CloneElement(elem))" title="Clone" />
                            <RadzenButton Icon="delete" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Danger" Click="@(args => ConfirmDelete(elem))" Disabled="@(!CanDeleteElement(elem))" title="Delete" />
                        </RadzenStack>
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
    }
}

@code {
    private enum ViewMode { Tiles, Grid }
    private const string ViewModeKey = "AdventureGame.ElementsPage.ViewMode";
    private const string SortModeKey = "AdventureGame.ElementsPage.SortMode";
    
    private ViewMode _viewMode = ViewMode.Tiles;
    private ViewMode viewMode
    {
        get => _viewMode;
        set
        {
            if (_viewMode != value)
            {
                _viewMode = value;
                Preferences.Default.Set(ViewModeKey, value.ToString());
            }
        }
    }
    
    private string searchText = "";
    
    private List<GameElement> elements = new();

    private List<ElementKindItem> elementKindItems = new();
    private ElementKind selectedKind = ElementKind.Item;

    private record DropdownKindItem(ElementKind? Kind, string Name);
    private List<DropdownKindItem> dropdownItems = new();
    private ElementKind? selectedKindNullable;

    private record SortOption(string Value, string Text);
    private List<SortOption> sortOptions = new()
    {
        new SortOption("name", "Sort: Name (A→Z)"),
        new SortOption("name-desc", "Sort: Name (Z→A)"),
        new SortOption("kind", "Sort: Kind"),
        new SortOption("location", "Sort: Location")
    };
    private string selectedSort = "name";

    protected override void OnInitialized()
    {
        elementKindItems = ElementFactory.All.ToList();

        if (elementKindItems.Any(e => e.Kind == ElementKind.Scene))
        {
            selectedKind = ElementKind.Scene;
        }
        else
        {
            selectedKind = elementKindItems.FirstOrDefault()?.Kind ?? ElementKind.Item;
        }

        dropdownItems = elementKindItems.Select(i => new DropdownKindItem(i.Kind, i.Name)).ToList();
        dropdownItems.Add(new DropdownKindItem(null, "All"));
        selectedKindNullable = selectedKind;

        // Restore view mode and sort preference from MAUI Preferences
        var savedViewMode = Preferences.Default.Get(ViewModeKey, "Tiles");
        _viewMode = Enum.TryParse<ViewMode>(savedViewMode, out var vm) ? vm : ViewMode.Tiles;
        
        selectedSort = Preferences.Default.Get(SortModeKey, "name");

        CurrentGameService.OnChange += Reload;
        Reload();
    }

    public void Dispose()
    {
        CurrentGameService.OnChange -= Reload;
    }

    private void Reload()
    {
        elements = CurrentGameService.CurrentPack?.Elements?.ToList() ?? new List<GameElement>();
        InvokeAsync(StateHasChanged);
    }

    private void OnSortChanged()
    {
        // Persist sort preference to MAUI Preferences
        Preferences.Default.Set(SortModeKey, selectedSort);
        StateHasChanged();
    }

    private IEnumerable<GameElement> GetFilteredElements()
    {
        if (selectedKindNullable is null) return elements;
        var type = ElementFactory.TypeOf(selectedKindNullable.Value);
        return elements.Where(e => e.GetType() == type).ToList();
    }

    private IEnumerable<GameElement> GetFilteredAndSearchedElements()
    {
        var filtered = GetFilteredElements();
        
        if (string.IsNullOrWhiteSpace(searchText))
            return filtered;
        
        var search = searchText.ToLowerInvariant();
        return filtered.Where(e => 
            e.Name.ToLowerInvariant().Contains(search) ||
            e.Description.ToLowerInvariant().Contains(search) ||
            e.Aliases.Any(a => a.ToLowerInvariant().Contains(search)) ||
            e.Tags.Any(t => t.ToLowerInvariant().Contains(search))
        );
    }

    private IEnumerable<GameElement> GetSortedElements()
    {
        var filtered = GetFilteredAndSearchedElements();
        
        return selectedSort switch
        {
            "name" => filtered.OrderBy(e => e.Name, StringComparer.OrdinalIgnoreCase),
            "name-desc" => filtered.OrderByDescending(e => e.Name, StringComparer.OrdinalIgnoreCase),
            "kind" => filtered.OrderBy(e => e.Kind.ToString()).ThenBy(e => e.Name, StringComparer.OrdinalIgnoreCase),
            "location" => filtered.OrderBy(e => GetLocationText(e), StringComparer.OrdinalIgnoreCase).ThenBy(e => e.Name, StringComparer.OrdinalIgnoreCase),
            _ => filtered.OrderBy(e => e.Name, StringComparer.OrdinalIgnoreCase)
        };
    }

    private async Task AddElement(ElementKind kind)
    {
        var e = ElementFactory.Create(kind);
        if (string.IsNullOrWhiteSpace(e.Name))
            e.Name = $"New {e.GetType().Name}";

        var parameters = new Dictionary<string, object?> { ["Element"] = e };
        var result = await DialogService.OpenSideAsync<GameElementEditor>(
            title: "New Element",
            parameters: parameters,
            options: new SideDialogOptions() { Width = "70%" }
        );

        if (result is GameElement saved)
        {
            saved.CanBeDeleted = true;
            CurrentGameService.CurrentPack!.Elements.Add(saved);
            CurrentGameService.MarkDirty();
            Reload();
        }
    }

    private void EditElement(GameElement e)
    {
        var parameters = new Dictionary<string, object?> { ["Element"] = e };
        DialogService.OpenSide<GameElementEditor>("Edit Element", parameters, new SideDialogOptions() { Width = "70%" });
    }

    private async Task CloneElement(GameElement e)
    {
        var json = System.Text.Json.JsonSerializer.Serialize(e, GamePack.JsonOptions);
        var newClone = System.Text.Json.JsonSerializer.Deserialize<GameElement>(json, GamePack.JsonOptions)!;

        try
        {
            var idProp = newClone.GetType().GetProperty("Id");
            if (idProp != null && idProp.CanWrite)
            {
                idProp.SetValue(newClone, ElementId.New());
            }
        }
        catch { }

        newClone.CanBeDeleted = true;
        CurrentGameService.CurrentPack!.Elements.Add(newClone);
        CurrentGameService.MarkDirty();
        Reload();

        await Task.CompletedTask;
    }

    private async Task ConfirmDelete(GameElement e)
    {
        if (!CanDeleteElement(e))
        {
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Warning, Summary = "Cannot delete", Detail = "This element cannot be deleted because it would remove the last Scene or Player, or it is protected.", Duration = 5000 });
            return;
        }

        var yes = await DialogService.Confirm($"Delete '{e.Name}'?", "Confirm Delete");
        if (yes == true)
        {
            CurrentGameService.CurrentPack!.Elements.RemoveAll(x => x.Id == e.Id);
            CurrentGameService.MarkDirty();
            Reload();
        }
    }

    private bool CanDeleteElement(GameElement e)
    {
        if (e.CanBeDeleted) return true;

        if (e is Scene)
        {
            var scenes = CurrentGameService.CurrentPack?.Elements?.OfType<Scene>().Count() ?? 0;
            return scenes > 1;
        }
        if (e is Player)
        {
            var players = CurrentGameService.CurrentPack?.Elements?.OfType<Player>().Count() ?? 0;
            return players > 1;
        }

        return false;
    }

    private string AddButtonLabel => selectedKindNullable is null
        ? "Add Element"
        : (elementKindItems.FirstOrDefault(i => i.Kind == selectedKindNullable.Value)?.Name is string n ? $"Add {n}" : $"Add {selectedKindNullable.Value}");

    private string GetLocationText(GameElement? elem)
    {
        if (elem is null)
            return "OffMap";

        if (elem is Scene s && s.Position is GridPosition pos)
        {
            var levelElement = CurrentGameService.CurrentPack?.Elements?.FirstOrDefault(e => e.Id == s.ParentId);
            return $"{levelElement?.Name ?? "World"} ({pos.X}, {pos.Y})";
        }

        if (elem.ParentId is ElementId parent)
        {
            var parentElement = CurrentGameService.CurrentPack?.Elements?.FirstOrDefault(e => e.Id == parent);
            return parentElement is not null ? $"{parentElement.Name}" : $"{parent.Value}";
        }

        return "OffMap";
    }
}