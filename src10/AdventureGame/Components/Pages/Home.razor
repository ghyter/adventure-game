@page "/"
@using Microsoft.ML.OnnxRuntime
@using Microsoft.ML.OnnxRuntime.Tensors
@inject NotificationService ns

<PageTitle>Home</PageTitle>

<RadzenText TextStyle="TextStyle.H3">Adventure Game</RadzenText>
<RadzenMarkdown>
This application allows you to create and manage text-based adventure games with ease. Use the sidebar to navigate through different sections of your game pack, including scenes, items, characters, and more.

##### Getting Started
- From the Games menu at the left, create a new Game Pack.  This stores all of your game data.
- To load an existing game pack, use the "Load Game Pack" option.
</RadzenMarkdown>

<RadzenText Text="@Output"/>

@code {
    private InferenceSession? aisession;
    private string Output = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        // Step 1: Open the packaged asset
        using var src = await FileSystem.OpenAppPackageFileAsync("model.onnx");

        // Step 2: Copy to real local app directory
        var localPath = Path.Combine(FileSystem.AppDataDirectory, "model.onnx");
        if (!File.Exists(localPath))
        {
            using var dest = File.Create(localPath);
            await src.CopyToAsync(dest);
        }

        // Step 3: Load ONNX from real local path
        aisession = new InferenceSession(localPath);

        var vec = TestEmbedding(aisession);
        Output = $"Output length: {vec.Length}";
    }

    private float[] TestEmbedding(InferenceSession session)
    {
        // Minimal sequence = [CLS=101, SEP=102]
        long[] ids = new long[] { 101, 102 };
        long[] mask = new long[] { 1, 1 };

        var idTensor = new DenseTensor<long>(ids, new[] { 1, ids.Length });
        var maskTensor = new DenseTensor<long>(mask, new[] { 1, ids.Length });

        // FIX: Provide token_type_ids (same length as input, usually all zeros)
        var typeTensor = new DenseTensor<long>(new[] { 1, ids.Length });
        for (int i = 0; i < ids.Length; i++)
            typeTensor.Buffer.Span[i] = 0;

        var inputs = new List<NamedOnnxValue>
    {
        NamedOnnxValue.CreateFromTensor("input_ids", idTensor),
        NamedOnnxValue.CreateFromTensor("attention_mask", maskTensor),
        NamedOnnxValue.CreateFromTensor("token_type_ids", typeTensor)
    };

        using var results = session.Run(inputs);

        return results.First().AsEnumerable<float>().ToArray();
    }


}
