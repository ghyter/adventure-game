@page "/"
@using System.Diagnostics
@using System.IO
@using AdventureGame.Components.Shared
@using AdventureGame.Engine.Conditions
@using AdventureGame.Engine.Effects
@using AdventureGame.Engine.Parameters
@using Microsoft.Maui.Storage
@inject NotificationService NotificationService
@inject IConditionOperatorCatalog conditionCatalog
@inject IEffectActionCatalog effectCatalog
@inject IParameterCatalog parameterCatalog


<PageTitle>Home</PageTitle>

<PageHeader Icon="home" Title="Adventure Game Editor" />

<RadzenStack Gap="16">
    <RadzenMarkdown>
This application allows you to create and manage text-based adventure games with ease. Use the sidebar to navigate through different sections of your game pack, including scenes, items, characters, and more.

##### Getting Started
- From the **Games** menu at the left, create a new Game Pack. This stores all of your game data.
- To load an existing game pack, use the "Load Game Pack" option.
- Use the **Tools** menu to test conditions and effects on your game packs.
    </RadzenMarkdown>

    <RadzenTabs>
        <Tabs>
            <RadzenTabsItem Text="Conditions">
                <RadzenStack Gap="8">
                    <RadzenText TextStyle="TextStyle.H6">⚙️ Condition Operators</RadzenText>
                    <RadzenText TextStyle="TextStyle.Body2">Available condition operators for your game:</RadzenText>
                    @if (Operators.Any())
                    {
                        <RadzenDataList Data="@Operators" TItem="IConditionOperator">
                            <Template Context="op">
                                <RadzenCard Style="margin-bottom: 8px; padding: 12px;">
                                    <RadzenStack Gap="4">
                                        <RadzenText TextStyle="TextStyle.Subtitle2">@op.DisplayName</RadzenText>
                                        <RadzenText TextStyle="TextStyle.Caption" Style="opacity: 0.7;">Key: @op.Key</RadzenText>
                                        <RadzenText TextStyle="TextStyle.Body2">@op.Description</RadzenText>
                                        @if (op.Parameters.Any())
                                        {
                                            <RadzenText TextStyle="TextStyle.Caption" Style="margin-top: 4px;">
                                                Parameters: @string.Join(", ", op.Parameters.Select(p => p.Name))
                                            </RadzenText>
                                        }
                                    </RadzenStack>
                                </RadzenCard>
                            </Template>
                        </RadzenDataList>
                    }
                    else
                    {
                        <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat">
                            No condition operators registered. Make sure GameElementServiceExtensions is properly configured.
                        </RadzenAlert>
                    }
                </RadzenStack>

            </RadzenTabsItem>
            <RadzenTabsItem Text="Effects">
                <RadzenStack Gap="8">
                    <RadzenText TextStyle="TextStyle.H6">⚙️ Effect Actions</RadzenText>
                    <RadzenText TextStyle="TextStyle.Body2">Available effect actions for your game:</RadzenText>
                    @if (Actions.Any())
                    {
                        <RadzenDataList Data="@Actions" TItem="IEffectAction">
                            <Template Context="action">
                                <RadzenCard Style="margin-bottom: 8px; padding: 12px;">
                                    <RadzenStack Gap="4">
                                        <RadzenText TextStyle="TextStyle.Subtitle2">@action.DisplayName</RadzenText>
                                        <RadzenText TextStyle="TextStyle.Caption" Style="opacity: 0.7;">Key: @action.Key</RadzenText>
                                        <RadzenText TextStyle="TextStyle.Body2">@action.Description</RadzenText>
                                        @if (action.Parameters.Any())
                                        {
                                            <RadzenText TextStyle="TextStyle.Caption" Style="margin-top: 4px;">
                                                Parameters: @string.Join(", ", action.Parameters.Select(p => p.Name))
                                            </RadzenText>
                                        }
                                    </RadzenStack>
                                </RadzenCard>
                            </Template>
                        </RadzenDataList>
                    }
                    else
                    {
                        <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat">
                            No effect actions registered. Make sure GameElementServiceExtensions is properly configured.
                        </RadzenAlert>
                    }
                </RadzenStack>

            </RadzenTabsItem>

            <RadzenTabsItem Text="Parameter Types">
                <RadzenStack Gap="8">
                    <RadzenText TextStyle="TextStyle.H6">⚙️ Parameter Types</RadzenText>
                    <RadzenText TextStyle="TextStyle.Body2">Available parameter types for your game:</RadzenText>
                    @if (Parameters.Any())
                    {
                        <RadzenDataList Data="@Parameters" TItem="IParameterTypeHandler">
                            <Template Context="parameter">
                                <RadzenCard Style="margin-bottom: 8px; padding: 12px;">
                                    <RadzenStack Gap="4">
                                        <RadzenText TextStyle="TextStyle.Subtitle2">@parameter.DisplayName</RadzenText>
                                        <RadzenText TextStyle="TextStyle.Caption" Style="opacity: 0.7;">Key: @parameter.Key</RadzenText>
                                        <RadzenText TextStyle="TextStyle.Body2">@parameter.EditorComponentTypeName</RadzenText>
                                    </RadzenStack>
                                </RadzenCard>
                            </Template>
                        </RadzenDataList>
                    }
                    else
                    {
                        <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat">
                            No parameter types registered. Make sure GameElementServiceExtensions is properly configured.
                        </RadzenAlert>
                    }
                </RadzenStack>

            </RadzenTabsItem>
        </Tabs>
    </RadzenTabs>


    <RadzenCard Style="background: var(--rz-primary-lighter); padding: 16px;">
        <RadzenStack Gap="8">
            <RadzenText TextStyle="TextStyle.H6">📁 GamePacks Folder</RadzenText>
            <RadzenText TextStyle="TextStyle.Body2">Your game packs are stored in:</RadzenText>
            <RadzenStack Orientation="Orientation.Horizontal" Gap="8" AlignItems="AlignItems.Center">
                <RadzenText TextStyle="TextStyle.Caption" Style="font-family: monospace; flex: 1;">@PacksFolder</RadzenText>
                <RadzenButton Icon="folder_open" Text="Open" Size="ButtonSize.Small" Click="@OpenPacksFolderAsync" />
            </RadzenStack>
        </RadzenStack>
    </RadzenCard>

    <RadzenText Text="@Output"/>
</RadzenStack>

@code {
    private string Output = string.Empty;
    private string PacksFolder = string.Empty;
    private IReadOnlyList<IConditionOperator> Operators = [];
    private IReadOnlyList<IEffectAction> Actions = [];
    private IReadOnlyList<IParameterTypeHandler> Parameters = [];


    protected override void OnInitialized()
    {
        try
        {
            PacksFolder = Path.Combine(FileSystem.AppDataDirectory, "GamePacks");
            Directory.CreateDirectory(PacksFolder);

            Operators = conditionCatalog.All;
            Actions = effectCatalog.All;
            Parameters = parameterCatalog.All.ToList();
        }
        catch { }
    }

    private async Task OpenPacksFolderAsync()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(PacksFolder))
            {
                PacksFolder = Path.Combine(FileSystem.AppDataDirectory, "GamePacks");
            }
            Directory.CreateDirectory(PacksFolder);
            // On Windows, open in File Explorer
            Process.Start(new ProcessStartInfo("explorer.exe", PacksFolder) { UseShellExecute = true });
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage 
            { 
                Severity = NotificationSeverity.Error, 
                Summary = "Open Folder failed", 
                Detail = ex.Message, 
                Duration = 4000 
            });
        }
    }
}
