@page "/embedding-playground"
@using AdventureGame.Engine.Models
@using AdventureGame.Engine.Models.Elements
@using AdventureGame.Engine.Services

@inject EmbeddingService Embeddings
@inject CurrentGameService GameService
@inject Radzen.NotificationService NotificationService

@if (!Embeddings.IsReady)
{
    <RadzenCard>
        <RadzenProgressBar Mode="ProgressBarMode.Indeterminate" />
        <p>Loading semantic model…</p>
    </RadzenCard>

    return;
}


<RadzenCard Style="margin:20px; padding:20px;">

    <p>
        Build embeddings for your current GamePack (scenes, items, NPCs)
        and run semantic searches on them.
    </p>

    <RadzenButton Text="Load GamePack & Generate Embeddings"
                  Icon="auto_awesome"
                  ButtonStyle="ButtonStyle.Primary"
                  Disabled="@IsLoading"
                  Click="@BuildEmbeddings" />

    @if (IsLoading)
    {
        <div class="mt-3">
            <RadzenProgressBar Mode="ProgressBarMode.Indeterminate" />
            <p>Building embeddings...</p>
        </div>
    }

    @if (IsReady)
    {
        <RadzenCard Style="margin-top:20px;">

            <RadzenTextBox @bind-Value="Query"
                           Placeholder="Try: 'dark cave', 'healing potion', 'royal guard', 'library'"
                           Style="width:100%; margin-bottom:10px" />

            <RadzenButton Text="Search"
                          Icon="search"
                          ButtonStyle="ButtonStyle.Secondary"
                          Disabled="@string.IsNullOrWhiteSpace(Query)"
                          Click="@Search" />

            @if (SearchResults.Any())
            {
                <RadzenDataGrid Data="@SearchResults" TItem="SearchResult" class="mt-4">
                    <Columns>
                        <RadzenDataGridColumn TItem="SearchResult" Property="Score" Title="Score" FormatString="0.000" Width="110px" />
                        <RadzenDataGridColumn TItem="SearchResult" Property="Type" Title="Type" Width="110px" />
                        <RadzenDataGridColumn TItem="SearchResult" Property="Id" Title="ID" Width="160px" />
                        <RadzenDataGridColumn TItem="SearchResult" Property="Text" Title="Text" />
                    </Columns>
                </RadzenDataGrid>
            }
        </RadzenCard>
    }
</RadzenCard>

@code {
    private bool IsLoading = false;
    private bool IsReady = false;

    private string Query = "";
    private float[]? QueryEmbedding;

    private readonly List<GameElementEmbedding> Index = new();
    private List<SearchResult> SearchResults = new();

    protected override void OnInitialized()
    {
        IsReady = false;

        // Make sure model begins loading even if user navigates here first
        Embeddings.StartLoadIfNeeded();

        if (Embeddings.IsReady)
        {
            IsReady = true;
        }
        else
        {
            Embeddings.Ready += OnEmbeddingsReady;
        }
    }

    private void OnEmbeddingsReady(object? sender, EventArgs e)
    {
        _ = InvokeAsync(() =>
        {
            IsReady = true;
            StateHasChanged();
        });
    }

    public void Dispose()
    {
        Embeddings.Ready -= OnEmbeddingsReady;
    }

    // ------------------------------------------------------
    // MAIN BUILD LOGIC
    // ------------------------------------------------------
    private async Task BuildEmbeddings()
    {
        IsLoading = true;
        IsReady = false;
        SearchResults.Clear();
        Index.Clear();

        var pack = GameService.CurrentPack;
        if (pack is null)
        {
            IsLoading = false;
            return;
        }

        // Build embeddings for Scenes
        foreach (var scene in pack.Elements.OfType<Scene>())
        {
            if (!string.IsNullOrWhiteSpace(scene.Description))
                await AddEmbedding($"Scene:{scene.Name}", scene.Id, scene.Description);
        }

        // Build embeddings for Items
        foreach (var item in pack.Elements.OfType<Item>())
        {
            if (!string.IsNullOrWhiteSpace(item.Description))
                await AddEmbedding($"Item:{item.Name}", item.Id, item.Description);
        }

        // Build embeddings for NPCs
        foreach (var npc in pack.Elements.OfType<Npc>())
        {
            if (!string.IsNullOrWhiteSpace(npc.Description))
                await AddEmbedding($"NPC:{npc.Name}", npc.Id, npc.Description);
        }

        IsLoading = false;
        IsReady = true;
    }

    private async Task AddEmbedding(string type, string id, string text)
    {
        var vec = await Embeddings.EmbedAsync(text);

        Index.Add(new GameElementEmbedding
        {
            Type = type,
            Id = id,
            Text = text,
            Vector = vec
        });
    }

    // ------------------------------------------------------
    // SEARCH
    // ------------------------------------------------------
    private async Task Search()
    {
        SearchResults.Clear();

        QueryEmbedding = await Embeddings.EmbedAsync(Query);

        foreach (var entry in Index)
        {
            var score = CosineSimilarity(entry.Vector, QueryEmbedding!);
            SearchResults.Add(new SearchResult
            {
                Score = score,
                Type = entry.Type,
                Id = entry.Id,
                Text = entry.Text
            });
        }

        SearchResults = SearchResults
            .OrderByDescending(r => r.Score)
            .Take(20)
            .ToList();
    }

    // ------------------------------------------------------
    // COSINE
    // ------------------------------------------------------
    private double CosineSimilarity(float[] a, float[] b)
    {
        if (a.Length == 0 || b.Length == 0)
            return 0.0; // No similarity possible

        if (a.Length != b.Length)
            return 0.0; // Mismatched vector dimensions

        double dot = 0, magA = 0, magB = 0;

        for (int i = 0; i < a.Length; i++)
        {
            dot += a[i] * b[i];
            magA += a[i] * a[i];
            magB += b[i] * b[i];
        }

        if (magA == 0 || magB == 0)
            return 0.0;

        return dot / (Math.Sqrt(magA) * Math.Sqrt(magB));
    }


    // ------------------------------------------------------
    // MODELS
    // ------------------------------------------------------
    public class GameElementEmbedding
    {
        public string Type { get; set; } = "";
        public string Id { get; set; } = "";
        public string Text { get; set; } = "";
        public float[] Vector { get; set; } = Array.Empty<float>();
    }

    public class SearchResult
    {
        public double Score { get; set; }
        public string Type { get; set; } = "";
        public string Id { get; set; } = "";
        public string Text { get; set; } = "";
    }
}
