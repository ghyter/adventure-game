@page "/embedding-playground"
@using AdventureGame.Engine.Models
@using AdventureGame.Engine.Models.Elements
@using AdventureGame.Engine.Services
@using AdventureGame.Services

@inject EmbeddingService Embeddings
@inject CurrentGameService GameService
@inject Radzen.NotificationService NotificationService
@inject LogService Logs

@if (!Embeddings.IsReady)
{
    <RadzenCard>
        <RadzenProgressBar Mode="ProgressBarMode.Indeterminate" />
        <p>Loading semantic model…</p>
    </RadzenCard>

    return;
}


<RadzenCard Style="margin:20px; padding:20px;">

    <p>
        Build embeddings for your current GamePack (scenes, items, NPCs)
        and run semantic searches on them.
    </p>

    <RadzenButton Text="Load GamePack & Generate Embeddings"
                  Icon="auto_awesome"
                  ButtonStyle="ButtonStyle.Primary"
                  Disabled="@IsLoading"
                  Click="@BuildEmbeddings" />

    @if (IsLoading)
    {
        <div class="mt-3">
            <RadzenProgressBar Mode="ProgressBarMode.Indeterminate" />
            <p>Building embeddings...</p>
        </div>
    }

    @if (IsReady)
    {
        <RadzenCard Style="margin-top:20px;">

            <RadzenStack Orientation="Orientation.Vertical" Gap="12">
                <!-- Search Info Section -->
                <RadzenAlert AlertStyle="AlertStyle.Info" ShowIcon="true">
                    <strong>How to Search:</strong> Enter keywords or phrases similar to your game element descriptions.
                    <br />
                    <strong>Clue Mansion Examples:</strong> Try searching for:
                    <br />
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="4" Style="flex-wrap: wrap; margin-top: 8px;">
                        <RadzenBadge Text="library" BadgeStyle="BadgeStyle.Info" />
                        <RadzenBadge Text="ballroom" BadgeStyle="BadgeStyle.Info" />
                        <RadzenBadge Text="firearm" BadgeStyle="BadgeStyle.Info" />
                        <RadzenBadge Text="academic" BadgeStyle="BadgeStyle.Info" />
                        <RadzenBadge Text="weapon" BadgeStyle="BadgeStyle.Info" />
                        <RadzenBadge Text="elegant" BadgeStyle="BadgeStyle.Info" />
                        <RadzenBadge Text="socialite" BadgeStyle="BadgeStyle.Info" />
                        <RadzenBadge Text="heavy" BadgeStyle="BadgeStyle.Info" />
                    </RadzenStack>
                </RadzenAlert>

                <!-- Search Input and Button -->
                <RadzenStack Orientation="Orientation.Horizontal" Gap="8">
                    <RadzenTextBox @bind-Value="Query"
                                   Placeholder="Try: 'dark cave', 'healing potion', 'royal guard', 'library'"
                                   Style="flex: 1; width: 100%;" />

                    <RadzenButton Text="Search"
                                  Icon="search"
                                  ButtonStyle="ButtonStyle.Secondary"
                                  Disabled="@string.IsNullOrWhiteSpace(Query)"
                                  Click="@Search"
                                  Style="white-space: nowrap;" />
                </RadzenStack>

                <!-- Results Section -->
                @if (SearchResults.Any())
                {
                    <div>
                        <RadzenText TextStyle="TextStyle.Subtitle2" Style="margin-bottom: 10px;">
                            Search Results (@SearchResults.Count found)
                        </RadzenText>
                        <RadzenDataGrid Data="@SearchResults" TItem="SearchResult" AllowFiltering="true" AllowPaging="true" PageSize="10">
                            <Columns>
                                <RadzenDataGridColumn TItem="SearchResult" Property="Score" Title="Score" Width="110px">
                                    <Template Context="data">
                                        @data.Score.ToString("F6")
                                    </Template>
                                </RadzenDataGridColumn>
                                <RadzenDataGridColumn TItem="SearchResult" Property="Type" Title="Type" Width="110px" />
                                <RadzenDataGridColumn TItem="SearchResult" Property="Id" Title="ID" Width="160px" />
                                <RadzenDataGridColumn TItem="SearchResult" Property="Text" Title="Text" />
                            </Columns>
                        </RadzenDataGrid>
                    </div>
                }
            </RadzenStack>
        </RadzenCard>
    }
</RadzenCard>

<!-- Log Console -->
<RadzenCard Style="margin:20px; padding:20px; margin-top:20px;">
    <RadzenStack Orientation="Orientation.Vertical" Gap="8">
        <RadzenStack Orientation="Orientation.Horizontal" Gap="8" AlignItems="AlignItems.Center">
            <RadzenText TextStyle="TextStyle.Subtitle2">Logs</RadzenText>
            <RadzenButton Icon="delete" Text="Clear" Size="ButtonSize.Small" Click="@ClearLogs" />
        </RadzenStack>

        <div style="border: 1px solid #ccc; border-radius: 4px; padding: 10px; height: 300px; overflow-y: auto; background-color: #f5f5f5; font-family: monospace; font-size: 12px;">
            @foreach (var logEntry in LogEntries)
            {
                <div>@logEntry</div>
            }
            @if (!LogEntries.Any())
            {
                <div style="color: #999;">No logs yet...</div>
            }
        </div>
    </RadzenStack>
</RadzenCard>

@code {
    private bool IsLoading = false;
    private bool IsReady = false;

    private string Query = "";
    private float[]? QueryEmbedding;

    private readonly List<GameElementEmbedding> Index = new();
    private List<SearchResult> SearchResults = new();
    private List<string> LogEntries = new();

    protected override void OnInitialized()
    {
        IsReady = false;

        // Make sure model begins loading even if user navigates here first
        Embeddings.StartLoadIfNeeded();

        if (Embeddings.IsReady)
        {
            IsReady = true;
        }
        else
        {
            Embeddings.Ready += OnEmbeddingsReady;
        }

        // Subscribe to log events
        Logs.LogReceived += OnLogReceived;

        // Load initial log history
        LogEntries = new List<string>(Logs.LogHistory);
    }

    private void OnEmbeddingsReady(object? sender, EventArgs e)
    {
        _ = InvokeAsync(() =>
        {
            IsReady = true;
            StateHasChanged();
        });
    }

    private void OnLogReceived(object? sender, LogEventArgs e)
    {
        _ = InvokeAsync(() =>
        {
            LogEntries.Add(e.Message);
            // Keep only last 500 logs in UI for performance
            if (LogEntries.Count > 500)
            {
                LogEntries.RemoveRange(0, LogEntries.Count - 500);
            }
            StateHasChanged();
        });
    }

    private void ClearLogs()
    {
        LogEntries.Clear();
        Logs.Clear();
        StateHasChanged();
    }

    public void Dispose()
    {
        Embeddings.Ready -= OnEmbeddingsReady;
        Logs.LogReceived -= OnLogReceived;
    }

    // ------------------------------------------------------
    // MAIN BUILD LOGIC
    // ------------------------------------------------------
    private async Task BuildEmbeddings()
    {
        IsLoading = true;
        IsReady = false;
        SearchResults.Clear();
        Index.Clear();

        var pack = GameService.CurrentPack;
        if (pack is null)
        {
            NotificationService.Notify(new NotificationMessage 
            { 
                Severity = NotificationSeverity.Warning, 
                Summary = "No GamePack", 
                Detail = "Please select a GamePack first.",
                Duration = 3000 
            });
            IsLoading = false;
            return;
        }

        int embeddingsCreated = 0;

        // Build embeddings for Scenes
        foreach (var scene in pack.Elements.OfType<Scene>())
        {
            if (!string.IsNullOrWhiteSpace(scene.Description))
            {
                await AddEmbedding($"Scene:{scene.Name}", scene.Id, scene.Description);
                embeddingsCreated++;
            }
        }

        // Build embeddings for Items
        foreach (var item in pack.Elements.OfType<Item>())
        {
            if (!string.IsNullOrWhiteSpace(item.Description))
            {
                await AddEmbedding($"Item:{item.Name}", item.Id, item.Description);
                embeddingsCreated++;
            }
        }

        // Build embeddings for NPCs
        foreach (var npc in pack.Elements.OfType<Npc>())
        {
            if (!string.IsNullOrWhiteSpace(npc.Description))
            {
                await AddEmbedding($"NPC:{npc.Name}", npc.Id, npc.Description);
                embeddingsCreated++;
            }
        }

        IsLoading = false;
        IsReady = true;
        await InvokeAsync(StateHasChanged);

        if (Index.Count > 0)
        {
            NotificationService.Notify(new NotificationMessage 
            { 
                Severity = NotificationSeverity.Success, 
                Summary = "Embeddings Created", 
                Detail = $"Generated {Index.Count} embeddings for semantic search.",
                Duration = 3000 
            });
        }
        else
        {
            NotificationService.Notify(new NotificationMessage 
            { 
                Severity = NotificationSeverity.Warning, 
                Summary = "No Embeddings", 
                Detail = "No valid descriptions found to embed.",
                Duration = 3000 
            });
        }
    }

    private async Task AddEmbedding(string type, string id, string text)
    {
        try
        {
            var vec = await Embeddings.EmbedAsync(text);
            
            if (vec.Length == 0)
            {
                // Skip empty embeddings
                return;
            }

            Index.Add(new GameElementEmbedding
            {
                Type = type,
                Id = id,
                Text = text,
                Vector = vec
            });
        }
        catch (Exception ex)
        {
            Logs.Log($"Failed to embed '{text}': {ex.Message}");
        }
    }

    // ------------------------------------------------------
    // SEARCH
    // ------------------------------------------------------
    private async Task Search()
    {
        if (Index.Count == 0)
        {
            NotificationService.Notify(new NotificationMessage 
            { 
                Severity = NotificationSeverity.Warning, 
                Summary = "No Index", 
                Detail = "Please generate embeddings first.",
                Duration = 2000 
            });
            return;
        }

        // Clear results immediately to show user that something is happening
        SearchResults.Clear();
        await InvokeAsync(StateHasChanged);

        try
        {
            Logs.Log($"Searching for: '{Query}'");
            QueryEmbedding = await Embeddings.EmbedAsync(Query);

            if (QueryEmbedding.Length == 0)
            {
                NotificationService.Notify(new NotificationMessage 
                { 
                    Severity = NotificationSeverity.Error, 
                    Summary = "Invalid Query", 
                    Detail = "Could not generate embedding for query.",
                    Duration = 2000 
                });
                return;
            }

            Logs.Log($"Query embedding generated with length: {QueryEmbedding.Length}");

            // Build results list
            var results = new List<SearchResult>();
            foreach (var entry in Index)
            {
                var score = CosineSimilarity(entry.Vector, QueryEmbedding!);
                Logs.Log($"[Search] Item '{entry.Type}' scored: {score:F6}");
                results.Add(new SearchResult
                {
                    Score = score,
                    Type = entry.Type,
                    Id = entry.Id,
                    Text = entry.Text
                });
            }

            // Sort and take top 20 - create new list reference for Radzen binding
            SearchResults = results
                .OrderByDescending(r => r.Score)
                .Take(20)
                .ToList();

            Logs.Log($"Search complete. Found {SearchResults.Count} results.");

            if (SearchResults.Count > 0)
            {
                Logs.Log($"Top result score: {SearchResults[0].Score:F6}");
                // Log first 5 results for debugging
                for (int i = 0; i < Math.Min(5, SearchResults.Count); i++)
                {
                    Logs.Log($"  [{i}] {SearchResults[i].Type}: {SearchResults[i].Score:F6}");
                }
            }
            else
            {
                NotificationService.Notify(new NotificationMessage 
                { 
                    Severity = NotificationSeverity.Info, 
                    Summary = "No Results", 
                    Detail = "No matches found for your query.",
                    Duration = 2000 
                });
            }

            // Ensure UI updates with new data
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Logs.Log($"Search error: {ex.Message}");
            NotificationService.Notify(new NotificationMessage 
            { 
                Severity = NotificationSeverity.Error, 
                Summary = "Search Failed", 
                Detail = ex.Message,
                Duration = 3000 
            });
        }
    }

    // ------------------------------------------------------
    // COSINE
    // ------------------------------------------------------
    private double CosineSimilarity(float[] a, float[] b)
    {
        if (a.Length == 0 || b.Length == 0)
        {
            Logs.Log($"[CosineSimilarity] Empty vector: a.Length={a.Length}, b.Length={b.Length}");
            return 0.0;
        }

        if (a.Length != b.Length)
        {
            Logs.Log($"[CosineSimilarity] Dimension mismatch: a.Length={a.Length}, b.Length={b.Length}");
            return 0.0;
        }

        // Since both embeddings are already normalized by EmbeddingService,
        // cosine similarity is just the dot product
        double dot = 0;
        for (int i = 0; i < a.Length; i++)
        {
            dot += a[i] * b[i];
        }

        // Debug: check if vectors have values
        var sumA = a.Sum(x => (double)x);
        var sumB = b.Sum(x => (double)x);
        
        if (Math.Abs(sumA) < 0.001f || Math.Abs(sumB) < 0.001f)
        {
            Logs.Log($"[CosineSimilarity] WARNING: Zero/near-zero sum. sumA={sumA:F6}, sumB={sumB:F6}, dot={dot:F6}");
            Logs.Log($"[CosineSimilarity] First 5 of a: [{string.Join(", ", a.Take(5).Select(x => x.ToString("F6")))}]");
            Logs.Log($"[CosineSimilarity] First 5 of b: [{string.Join(", ", b.Take(5).Select(x => x.ToString("F6")))}]");
        }

        return dot;
    }


    // ------------------------------------------------------
    // MODELS
    // ------------------------------------------------------
    public class GameElementEmbedding
    {
        public string Type { get; set; } = "";
        public string Id { get; set; } = "";
        public string Text { get; set; } = "";
        public float[] Vector { get; set; } = Array.Empty<float>();
    }

    public class SearchResult
    {
        public double Score { get; set; }
        public string Type { get; set; } = "";
        public string Id { get; set; } = "";
        public string Text { get; set; } = "";
    }
}
